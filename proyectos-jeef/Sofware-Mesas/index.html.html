<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Mesas y Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--secondary-color);
        }
        
        .card-mesa:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa.libre {
            background-color: #e8f5e9;
        }

        .card-mesa.deshabilitada {
            background-color: #f5f5f5;
        }
        
        .estado-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .estado-libre {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .estado-deshabilitada {
            background-color: #f5f5f5;
            color: #9e9e9e;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-error {
            border: 1px solid var(--accent-color) !important;
        }
        
        .error-message {
            color: var(--accent-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .temporizador-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .temporizador-activo {
            color: #dc3545;
            font-weight: bold;
        }
        
        #filtroFecha{
            width: 20vw;
        }

        .ocasion-img {
            height: 80px;
            width: 80px;
            display: inline-block;
            object-fit: contain;
            vertical-align: middle;
        }

        .reserva-activa {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        @media (max-width: 768px) {
            .mesas-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1>üçΩÔ∏è Sistema de Gesti√≥n de Mesas</h1>
        <p class="lead">Administra tus mesas y reservas de forma eficiente</p>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Mesas Disponibles</h2>
                    <button type="button" class="btn btn-primary-custom text-white" data-bs-toggle="modal" data-bs-target="#modalMesas">
                        + Agregar Mesa
                    </button>
                </div>
           
                <div id="bodyData" class="mesas-grid"></div>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Gesti√≥n de Reservas</h2>
                    <button id="btnReserva" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalReservas" onclick="abrirModalNuevaReserva()">
                        ‚ûï Hacer Reserva
                    </button>
                </div>
                
                <!-- Modal Reservas -->
                <div class="modal fade" id="modalReservas" tabindex="-1" aria-labelledby="modalReservasLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalReservasLabel">Registro de Reserva</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="idreserva" class="form-label">ID √∫nico de la reserva</label>
                                        <input type="number" id="idreserva" class="form-control" required>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="select-mesa" class="form-label">Seleccione una mesa</label>
                                        <select id="select-mesa" class="form-select" required>
                                            <option value="">Seleccione una mesa</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="nombreCliente" class="form-label">Nombre del cliente</label>
                                        <input type="text" id="nombreCliente" class="form-control" required>
                                        <div id="errorNombre" class="error-message">‚ö†Ô∏è El nombre es obligatorio</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="NumReservas" class="form-label">N√∫mero de personas</label>
                                        <input type="number" id="NumReservas" class="form-control" required min="1">
                                        <div id="errorNombre1" class="error-message">‚ö†Ô∏è El n√∫mero de personas es obligatorio</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="Datereserva" class="form-label">Fecha de reserva</label>
                                        <input type="date" id="Datereserva" class="form-control">
                                        <div id="errorNombre2" class="error-message">‚ö†Ô∏è La fecha es obligatoria</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="hora-reserva" class="form-label">Hora de reserva</label>
                                        <input type="time" id="hora-reserva" class="form-control" min="08:00" max="23:59">
                                        <div id="errorHora" class="error-message">‚ö†Ô∏è La hora es obligatoria (entre 8:00 y 23:59)</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="duracion-reserva" class="form-label">Duraci√≥n estimada</label>
                                        <select id="duracion-reserva" class="form-select">
                                            <option value="1">1 hora</option>
                                            <option value="2" selected>2 horas</option>
                                            <option value="3">3 horas</option>
                                            <option value="4">4 horas</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="ocasiones-especiales" class="form-label">Ocasi√≥n especial</label>
                                        <select id="ocasiones-especiales" class="form-select">
                                            <option value="cumplea√±os">Cumplea√±os</option>
                                            <option value="Aniversario">Aniversario</option>
                                            <option value="Reunion de Negocios">Reuni√≥n de Negocios</option>
                                            <option value="Boda">Boda</option>
                                            <option value="Despedida">Despedida</option>
                                            <option value="Graduacion">Graduaci√≥n</option>
                                            <option value="Compromiso">Compromiso</option>
                                            <option value="Dia de la Madre">D√≠a de la Madre</option>
                                            <option value="Dia del Padre">D√≠a del Padre</option>
                                            <option value="San Valentin">San Valent√≠n</option>
                                            <option value="Navidad">Navidad</option>
                                            <option value="A√±o Nuevo">A√±o Nuevo</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-12 mb-3">
                                        <label for="Notas" class="form-label">Notas para la atenci√≥n</label>
                                        <textarea id="Notas" class="form-control" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="estado" class="form-label">Estado de la reserva</label>
                                        <select id="estado" class="form-select">
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="Confirmada" selected>Confirmada</option>
                                            <option value="Cancelada">Cancelada</option>
                                            <option value="Finalizada">Finalizada</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button id="save" onclick="guardarNew()" class="btn btn-primary-custom text-white">Guardar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <label for="filtroFecha" class="form-label">Filtrar por fecha</label>
                        <input type="date" id="filtroFecha" class="form-control" onchange="pintarDatosNew()">
                    </div>
                    <div class="col-md-4">
                        <label for="filtroEstado" class="form-label">Filtrar por estado</label>
                        <select id="filtroEstado" class="form-control" onchange="pintarDatosNew()">
                            <option value="">-- Todos --</option>
                            <option value="Confirmada">Confirmada</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="Finalizada">Finalizada</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla de Reservas -->
                <div class="mt-5">
                    <h3 class="mb-3">Reservas Existentes</h3>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-custom">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Mesa</th>
                                    <th>Cliente</th>
                                    <th>Personas</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Duraci√≥n</th>
                                    <th>Ocasi√≥n</th>
                                    <th>Notas</th>
                                    <th>Estado</th>
                                    <th>Tiempo</th>
                                    <th>Opciones</th>
                                </tr>
                            </thead>
                            <tbody id="infoData"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="form-container">
                    <h3>Estad√≠sticas</h3>
                    <div class="d-flex justify-content-around text-center my-4">
                        <div>
                            <div class="fs-1 fw-bold" id="total-mesas">0</div>
                            <div>Total Mesas</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="mesas-libres">0</div>
                            <div>Mesas Libres</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="total-reservas">0</div>
                            <div>Total Reservas</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4>Reservas de Hoy</h4>
                        <div id="reservas-hoy" class="mt-3"></div>
                    </div>
                    <div class="filter mt-4">
                        <h4>Reservas Activas</h4>
                        <div id="filtroConfirmadas"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar mesas -->
    <div class="modal fade" id="modalMesas" tabindex="-1" aria-labelledby="modalMesasLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMesasLabel">Agregar mesa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-numero" class="form-label">N√∫mero de mesa</label>
                        <input type="number" id="modal-numero" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modal-cantidad" class="form-label">Cantidad de personas</label>
                        <input type="number" id="modal-cantidad" class="form-control" required min="1">
                        <div id="errorCantidad" class="error-message">‚ö†Ô∏è La cantidad debe ser mayor a 0</div>
                    </div>
                    <div class="mb-3">
                        <label for="modal-ubicacion" class="form-label">Ubicaci√≥n</label>
                        <input type="text" id="modal-ubicacion" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-estado" class="form-label">Estado</label>
                        <select id="modal-estado" class="form-select">
                            <option value="Libre">Libre</option>
                  <option value="Ocupada">Ocupada</option>
                            <option value="Deshabilitada">Deshabilitada</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom text-white" id="btnGuardarModal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar localStorage
        if (!localStorage.getItem("mesas")) {
            localStorage.setItem("mesas", JSON.stringify([]));
        }
        
        if (!localStorage.getItem("reservas")) {
            localStorage.setItem("reservas", JSON.stringify([]));
        }

        let mesas = JSON.parse(localStorage.getItem("mesas"));
        let datos = JSON.parse(localStorage.getItem("reservas"));
        let editIndex = null;
        let editIndexReserva = null;
        let temporizadoresActivos = {};

        // ==================== FUNCIONES DEL TEMPORIZADOR ====================

        window.onload = function () {
            if (localStorage.getItem("reservas")) {
                datos = JSON.parse(localStorage.getItem("reservas"));
            }

            if (localStorage.getItem("mesas")) {
                mesas = JSON.parse(localStorage.getItem("mesas"));
            }

            pintarDatos();
            pintarDatosNew();
            actualizarEstadisticas();
            recuperarTemporizadores();
        };

        // Validaci√≥n de horario de reserva
        function validarHorarioReserva(mesa, fecha, hora, duracion, reservaId = null) {
            const duracionMs = duracion * 60 * 60 * 1000; // Convertir horas a milisegundos
            const nuevaReservaInicio = new Date(`${fecha}T${hora}`);
            const nuevaReservaFin = new Date(nuevaReservaInicio.getTime() + duracionMs);

            // Validar horario (8:00 - 23:59)
            const apertura = new Date(`${fecha}T08:00`);
            const cierre = new Date(`${fecha}T23:59`);

            if (nuevaReservaInicio < apertura || nuevaReservaFin > cierre) {
                return false;
            }

            // Validar conflictos con otras reservas
            return !datos.some(reserva => {
                if (reserva.mesa != mesa) return false;
                if (reservaId && reserva.id == reservaId) return false;
                if (reserva.fecha != fecha) return false;
                if (reserva.estado === "Cancelada" || reserva.estado === "Finalizada") return false;

                const reservaExistenteInicio = new Date(`${reserva.fecha}T${reserva.hora}`);
                const reservaExistenteFin = new Date(reservaExistenteInicio.getTime() + (reserva.duracion * 60 * 60 * 1000));

                const hayConflicto = nuevaReservaInicio < reservaExistenteFin &&
                                     nuevaReservaFin > reservaExistenteInicio;

                return hayConflicto;
            });
        }

        // Iniciar temporizador para reservas confirmadas
        // function iniciarTemporizador(reservaId, startTime, duracionHoras) {
        //     if (temporizadoresActivos[reservaId]) {
        //         clearInterval(temporizadoresActivos[reservaId]);
        //     }

        //     temporizadoresActivos[reservaId] = setInterval(() => {
        //         const ahora = Date.now();
        //         const fin = startTime + (duracionHoras * 60 * 60 * 1000);
        //         const tiempoRestante = fin - ahora;

        //         if (tiempoRestante <= 0) {
        //             // Tiempo cumplido - marcar como finalizada
        //             const reservaIndex = datos.findIndex(r => r.id === reservaId);
        //             if (reservaIndex !== -1) {
        //                 datos[reservaIndex].estado = "Finalizada";
        //                 localStorage.setItem("reservas", JSON.stringify(datos));
                        
        //                 // La mesa se mantiene libre (no existe estado "Ocupada")
        //                 pintarDatosNew();
        //                 actualizarEstadisticas();
        //             }

        //             document.querySelector(`#temporizador-${reservaId}`).innerHTML = 
        //                 `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
                    
        //             clearInterval(temporizadoresActivos[reservaId]);
        //             delete temporizadoresActivos[reservaId];
        //             return;
        //         }

        //         actualizarContadorTemporizador(reservaId, startTime, duracionHoras);
        //     }, 1000);
        // }

        // // Actualizar contador del temporizador
        // function actualizarContadorTemporizador(reservaId, startTime, duracionHoras) {
        //     const ahora = Date.now();
        //     const fin = startTime + (duracionHoras * 60 * 60 * 1000);
        //     const tiempoRestante = fin - ahora;

        //     if (tiempoRestante <= 0) return;

        //     const horasRestantes = Math.floor(tiempoRestante / (1000 * 60 * 60));
        //     const minutosRestantes = Math.floor((tiempoRestante % (1000 * 60 * 60)) / (1000 * 60));

        //     const elemento = document.querySelector(`#temporizador-${reservaId}`);
        //     if (elemento) {
        //         elemento.innerHTML = `‚åõ ${horasRestantes}h ${minutosRestantes}m`;
                
        //         if (horasRestantes < 1) {
        //             elemento.classList.add('temporizador-activo');
        //         } else {
        //             elemento.classList.remove('temporizador-activo');
        //         }
        //     }
        // }

        // // Recuperar temporizadores al cargar
        // function recuperarTemporizadores() {
        //     datos.forEach(reserva => {
        //         if (reserva.startTime && reserva.duracion && reserva.estado === "Confirmada") {
        //             iniciarTemporizador(reserva.id, parseInt(reserva.startTime), parseInt(reserva.duracion));
        //         }
        //     });
        // }


function iniciarTemporizador(idReserva, startTime, duracionMinutos) {
    const reserva = datos.find(r => r.id == idReserva);
    if (!reserva) return;

    // Limpiamos intervalos anteriores
    if (reserva._intervalId) clearInterval(reserva._intervalId);

    reserva._intervalId = setInterval(() => {
        const ahora = Date.now();

        if (reserva.estado === "Pendiente") {
            const tiempoParaInicio = startTime - ahora; // ms restantes para que llegue la hora

            const elemento = document.querySelector(`#temporizador-${idReserva}`);
            if (elemento) {
                if (tiempoParaInicio > 0) {
                    const minutos = Math.floor(tiempoParaInicio / 60000);
                    const segundos = Math.floor((tiempoParaInicio % 60000) / 1000);
                    elemento.innerHTML = `‚åõ ${minutos}m ${segundos}s para iniciar`;
                } else {
                    // Ha llegado la hora ‚Üí pasar a Confirmada
                    reserva.estado = "Confirmada";

                    // Marcar mesa ocupada
                    const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
                    if (mesaIndex !== -1) mesas[mesaIndex].estado = "Ocupada";

                    localStorage.setItem("reservas", JSON.stringify(datos));
                    localStorage.setItem("mesas", JSON.stringify(mesas));

                    Swal.fire({
                        icon: "info",
                        title: "Reserva confirmada autom√°ticamente",
                        text: `La reserva de ${reserva.cliente} ha sido confirmada.`,
                        timer: 3000,
                        showConfirmButton: false
                    });

                    // Actualizar interfaz
                    pintarDatos();
                    pintarDatosNew();
                }
            }
        } else if (reserva.estado === "Confirmada") {
            const fin = startTime + duracionMinutos * 60000;
            const tiempoRestante = fin - ahora;
            const elemento = document.querySelector(`#temporizador-${idReserva}`);

            if (elemento) {
                if (tiempoRestante > 0) {
                    const minutos = Math.floor(tiempoRestante / 60000);
                    const segundos = Math.floor((tiempoRestante % 60000) / 1000);
                    elemento.innerHTML = `‚åõ ${minutos}m ${segundos}s restantes`;
                } else {
                    // Finalizar reserva
                    reserva.estado = "Finalizada";
                    const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
                    if (mesaIndex !== -1) mesas[mesaIndex].estado = "Libre";

                    clearInterval(reserva._intervalId);
                    delete reserva._intervalId;

                    localStorage.setItem("reservas", JSON.stringify(datos));
                    localStorage.setItem("mesas", JSON.stringify(mesas));

                    pintarDatos();
                    pintarDatosNew();
                    actualizarEstadisticas();
                }
            }
        }
    }, 1000);
}


// function iniciarTemporizador(reservaId, startTime, duracionHoras) {
//     if (temporizadoresActivos[reservaId]) {
//         clearInterval(temporizadoresActivos[reservaId]);
//     }

//     temporizadoresActivos[reservaId] = setInterval(() => {
//         const ahora = Date.now();
//         const reserva = datos.find(r => r.id === reservaId);
//         if (!reserva) return;

//         // üîπ Si est√° pendiente y lleg√≥ la hora, pasar a Confirmada
//         if (reserva.estado === "Pendiente" && ahora >= reserva.startTime) {
//             reserva.estado = "Confirmada";

//             // Actualizar mesa
//             const mesa = mesas.find(m => m.numero == reserva.mesa);
//             if (mesa) mesa.estado = "Ocupada";

//             localStorage.setItem("reservas", JSON.stringify(datos));
//             localStorage.setItem("mesas", JSON.stringify(mesas));
//             pintarDatosNew();
//         }

//         // üîπ Si es confirmada, calcular tiempo restante
//         if (reserva.estado === "Confirmada") {
//             const fin = reserva.startTime + duracionHoras * 60 * 60 * 1000;
//             const tiempoRestante = fin - ahora;

//             const elemento = document.querySelector(`#temporizador-${reservaId}`);
//             if (elemento) {
//                 if (tiempoRestante > 0) {
//                     const horasRestantes = Math.floor(tiempoRestante / (1000 * 60 * 60));
//                     const minutosRestantes = Math.floor((tiempoRestante % (1000 * 60 * 60)) / (1000 * 60));
//                     elemento.innerHTML = `‚åõ ${horasRestantes}h ${minutosRestantes}m`;

//                     if (horasRestantes < 1) {
//                         elemento.classList.add('temporizador-activo');
//                     } else {
//                         elemento.classList.remove('temporizador-activo');
//                     }
//                 } else {
//                     elemento.innerHTML = `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
//                     reserva.estado = "Finalizada";

//                     // Liberar mesa
//                     const mesa = mesas.find(m => m.numero == reserva.mesa);
//                     if (mesa) mesa.estado = "Libre";

//                     localStorage.setItem("reservas", JSON.stringify(datos));
//                     localStorage.setItem("mesas", JSON.stringify(mesas));
//                     pintarDatosNew();
//                     actualizarEstadisticas();

//                     clearInterval(temporizadoresActivos[reservaId]);
//                     delete temporizadoresActivos[reservaId];
//                     return;
//                 }
//             }
//         }
//     }, 1000);
// }

function recuperarTemporizadores() {
    datos.forEach(reserva => {
        if (reserva.startTime && reserva.duracion && ["Pendiente","Confirmada"].includes(reserva.estado)) {
            iniciarTemporizador(reserva.id, parseInt(reserva.startTime), parseInt(reserva.duracion));
        }
    });
}


        // ==================== FUNCIONES DE MESAS ====================

        function obtenerSiguienteNumeroMesa() {
            if (mesas.length === 0) return 1;
            const max = Math.max(...mesas.map(m => Number(m.numero)));
            return max > 0 ? max + 1 : 1;
        }

        document.querySelector('[data-bs-target="#modalMesas"]').addEventListener("click", () => {
            editIndex = null;
            document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            document.getElementById("modal-numero").value = obtenerSiguienteNumeroMesa();
            document.getElementById("modal-cantidad").value = "";
            document.getElementById("modal-ubicacion").value = "";
            document.getElementById("modal-estado").value = "Libre";
            
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
        });

        const guardarDesdeModal = () => {
            const numero = document.getElementById("modal-numero").value;
            const cantidad = document.getElementById("modal-cantidad").value;
            const ubicacion = document.getElementById("modal-ubicacion").value.trim();
            const estado = document.getElementById("modal-estado").value;
            let isValid = true;
            
            if (!cantidad || cantidad <= 0) {
                document.getElementById("modal-cantidad").classList.add('input-error');
                document.getElementById("errorCantidad").style.display = 'block';
                isValid = false;
            }
            
            if (!ubicacion) {
                document.getElementById("modal-ubicacion").classList.add('input-error');
                isValid = false;
            }
            
            if (!isValid) return;
            
            if (editIndex === null) {
                const reg = { numero, cantidad, ubicacion, estado };
                mesas.push(reg);
            } else {
                mesas[editIndex].cantidad = cantidad;
                mesas[editIndex].ubicacion = ubicacion;
                mesas[editIndex].estado = estado;
                editIndex = null;
                document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            }

            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatos();
            actualizarEstadisticas();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById("modalMesas"));
            modal.hide();
        };

//         function actualizarSelectMesas() {
//             const selectMesa = document.getElementById("select-mesa");
//             selectMesa.innerHTML = '<option value="">Seleccione una mesa</option>';
            
//             mesas.forEach((mesa) => {
//                 if (mesa.estado === "Libre") {
//                     const option = document.createElement("option");
//                     option.value = mesa.numero;
//                     option.textContent = `Mesa ${mesa.numero} - (${mesa.cantidad} personas)`;
//                     selectMesa.appendChild(option);
//                 }
//  if (mesa.estado === "Ocupada") {
//                     const option = document.createElement("option");
//                     option.value = mesa.numero;
//                     option.textContent = `Mesa ${mesa.numero} - (${mesa.cantidad} personas)`;
//                     selectMesa.appendChild(option);
//                 }
//             });
//         }

function actualizarSelectMesas() {
    const selectMesa = document.getElementById("select-mesa");
    selectMesa.innerHTML = "";

    // Filtrar solo las mesas disponibles
    const mesasDisponibles = mesas.filter(m => m.estado === "Libre");

    if (mesasDisponibles.length === 0) {
        const option = document.createElement("option");
        option.textContent = "No hay mesas disponibles";
        option.disabled = true;
        option.selected = true;
        selectMesa.appendChild(option);
        return;
    }

    mesasDisponibles.forEach(m => {
        const option = document.createElement("option");
        option.value = m.numero;
        option.textContent = `Mesa ${m.numero} - ${m.ubicacion}`;
        selectMesa.appendChild(option);
    });
}


        // const pintarDatos = () => {
        //     const body = document.getElementById("bodyData");
        //     body.innerHTML = "";
            
        //     mesas.forEach((item, i) => {
        //         const card = document.createElement("div");
        //         card.className = `card-mesa ${item.estado.toLowerCase()}`;
                
        //         const estadoClass = `estado-badge estado-${item.estado.toLowerCase()}`;
                
        //         card.innerHTML = `
        //             <div class="d-flex justify-content-between align-items-center mb-2">
        //                 <h4 class="mb-0">Mesa #${item.numero}</h4>
        //                 <span class="${estadoClass}">${item.estado}</span>
        //             </div>
        //             <div class="mb-3">
        //                 <strong>Capacidad:</strong> ${item.cantidad} personas
        //             </div>
        //             <div class="mb-3">
        //                 <strong>Ubicaci√≥n:</strong> ${item.ubicacion}
        //             </div>
        //             <div class="botones d-flex gap-2">
        //                 <button class="btn btn-sm btn-warning flex-fill" onclick="editarMesa(${i})">‚úèÔ∏è Editar</button>
        //                 <button class="btn btn-sm btn-danger flex-fill" onclick="eliminarMesa(${i})">üóëÔ∏è Eliminar</button>
        //                 ${item.estado !== "Deshabilitada" ? 
        //                     `<button class="btn btn-sm btn-success flex-fill" onclick="reservarMesa2(${i})">üìå Reservar</button>` : ''}
        //             </div>
        //         `;
                
        //         body.appendChild(card);
        //     });
            
        //     actualizarSelectMesas();
        // };
const pintarDatos = () => {
    const body = document.getElementById("bodyData");
    body.innerHTML = "";
    
    mesas.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = `card-mesa ${item.estado.toLowerCase()}`;
        
        const estadoClass = `estado-badge estado-${item.estado.toLowerCase()}`;

        // üé® Color de fondo seg√∫n el estado
        let backgroundColor = "";
        if (item.estado === "Ocupada") {
            backgroundColor = "background: linear-gradient(to right, #ff4b2b, #ff416c); color: white;";
        } else if (item.estado === "Confirmada") {
            backgroundColor = "background: linear-gradient(to right, #ffe259, #ffa751);";
        } else if (item.estado === "Libre") {
            backgroundColor = "background: linear-gradient(to right, #4facfe, #00f2fe); color: white;";
        } else {
            backgroundColor = "background: #f0f0f0;"; // por defecto
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Mesa #${item.numero}</h4>
                <span class="${estadoClass}">${item.estado}</span>
            </div>
            <div class="mb-3">
                <strong>Capacidad:</strong> ${item.cantidad} personas
            </div>
            <div class="mb-3">
                <strong>Ubicaci√≥n:</strong> ${item.ubicacion}
            </div>
            <div class="botones d-flex gap-2">
                <button class="btn btn-sm btn-warning flex-fill" onclick="editarMesa(${i})">‚úèÔ∏è Editar</button>
                <button class="btn btn-sm btn-danger flex-fill" onclick="eliminarMesa(${i})">üóëÔ∏è Eliminar</button>

              ${item.estado !== "Deshabilitada" && item.estado !== "Ocupada" ? 
    `<button class="btn btn-sm btn-success flex-fill" onclick="reservarMesa2(${i}); abrirModalNuevaReserva()">üìå Reservar</button>` : ''}

            </div>
        `;

        // aplicar color de fondo din√°mico
        card.setAttribute("style", backgroundColor);
        
        body.appendChild(card);
    });
    
    actualizarSelectMesas();
};


        function reservarMesa2(index) {
            const modalElement = document.getElementById("modalReservas");
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        window.editarMesa = (i) => {
            const mesa = mesas[i];
            editIndex = i;
            
            document.getElementById("modal-numero").value = mesa.numero;
            document.getElementById("modal-cantidad").value = mesa.cantidad;
            document.getElementById("modal-ubicacion").value = mesa.ubicacion;
            document.getElementById("modal-estado").value = mesa.estado;
            
            document.getElementById("modalMesasLabel").textContent = "Editar mesa";
            
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
            
            const modal = new bootstrap.Modal(document.getElementById("modalMesas"));
            modal.show();
        };

        window.eliminarMesa = (i) => {
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: "Esta acci√≥n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    mesas.splice(i, 1);
                    localStorage.setItem("mesas", JSON.stringify(mesas));
                    pintarDatos();
                    actualizarEstadisticas();
                    Swal.fire('Eliminada!', 'La mesa ha sido eliminada.', 'success');
                }
            });
        };

        // ==================== FUNCIONES DE RESERVAS ====================

    //     // Configurar fecha m√≠nima
    //     document.addEventListener("DOMContentLoaded", () => {
    //         const fechaInput = document.getElementById("Datereserva");
    //         const hoy = new Date().toISOString().split("T")[0];
    //         fechaInput.setAttribute("min", hoy);

    //         fechaInput.addEventListener("change", () => {
    //            if (fechaInput.value < hoy) {
    //                alert("‚ö†Ô∏è No puedes seleccionar una fecha pasada.");
    //                fechaInput.value = hoy;
    //            }
    //        });
    //    });

document.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("Datereserva");

    // üóìÔ∏è Generar la fecha local de hoy (no en UTC)
    const hoy = new Date();
    const year = hoy.getFullYear();
    const month = String(hoy.getMonth() + 1).padStart(2, "0");
    const day = String(hoy.getDate()).padStart(2, "0");
    const fechaLocal = `${year}-${month}-${day}`;

    // ‚úÖ Establecer fecha m√≠nima permitida (hoy)
    fechaInput.setAttribute("min", fechaLocal);

    // üö´ Validar cuando el usuario cambia la fecha
    fechaInput.addEventListener("change", () => {
        if (fechaInput.value < fechaLocal) {
            alert("‚ö†Ô∏è No puedes seleccionar una fecha pasada.");
            fechaInput.value = fechaLocal;
        }
    });

    // ‚è∞ (Opcional) Validar hora si quieres evitar horas pasadas del mismo d√≠a
    const horaInput = document.getElementById("hora-reserva");
    if (horaInput) {
        horaInput.addEventListener("change", () => {
            const ahora = new Date();
            const seleccionada = new Date(`${fechaInput.value}T${horaInput.value}`);

            if (seleccionada < ahora) {
                alert("‚ö†Ô∏è No puedes seleccionar una hora pasada.");
                horaInput.value = "";
            }
        });
    }
});


        function getImagenPorOcasion(ocasion) {
            const imagenes = {
                "cumplea√±os": "https://png.pngtree.com/png-vector/20240816/ourmid/pngtree-colorful-balloon-happy-birthday-text-with-festive-decorations-png-image_13507141.png",
                "Aniversario": "https://i.imgur.com/IkqU7J7.png",
                "Reunion de Negocios": "https://i.imgur.com/6vE6pcv.png",
                "Boda": "https://i.imgur.com/3ny2rTh.png",
                "Despedida": "https://i.imgur.com/9W3mEoW.png",
                "Graduacion": "https://i.imgur.com/MZAkSUO.png",
                "Compromiso": "https://i.imgur.com/EjZqvQ7.png",
                "Dia de la Madre": "https://i.imgur.com/r4C6eo9.png",
                "Dia del Padre": "https://i.imgur.com/t0O6dVZ.png",
                "San Valentin": "https://i.imgur.com/EGZ1hdV.png",
                "Navidad": "https://i.imgur.com/Ia0JODJ.png",
                "A√±o Nuevo": "https://i.imgur.com/Nxj3hRP.png"
            };
            const src = imagenes[ocasion];
            return src ? `<img src="${src}" alt="${ocasion}" class="ocasion-img">` : "";
        }

// function abrirModalNuevaReserva() {
//     // Limpiar formulario
//     limpiarFormularioNew();

//     // Generar siguiente ID autom√°ticamente
//     const siguienteId = obtenerSiguienteIdReserva();
//     const inputId = document.getElementById("idreserva");
//     inputId.value = siguienteId;
//     inputId.readOnly = true; // ‚ùå No editable

//     // Abrir modal
//     const modalEl = document.getElementById("modalReservas");
//     const modal = new bootstrap.Modal(modalEl);
//     modal.show();
// }

function abrirModalNuevaReserva() {
    // Limpiar formulario
    limpiarFormularioNew();

    // Generar ID autom√°tico para la reserva
    document.getElementById("idreserva").value = obtenerSiguienteIdReserva();

    // Configurar estado inicial
    document.getElementById("estado").value = "Pendiente";

    // Abrir modal
    const modalEl = document.getElementById("modalReservas");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

function guardarNew() {
    // ‚úÖ Validaciones b√°sicas
    let isValid = true;
    const nombre = document.getElementById("nombreCliente").value.trim();
    const personas = document.getElementById("NumReservas").value;
    const fecha = document.getElementById("Datereserva").value;
    const hora = document.getElementById("hora-reserva").value;

    if (!nombre) {
        document.getElementById("nombreCliente").classList.add('input-error');
        document.getElementById("errorNombre").style.display = 'block';
        isValid = false;
    }

    if (!personas || personas < 1) {
        document.getElementById("NumReservas").classList.add('input-error');
        document.getElementById("errorNombre1").style.display = 'block';
        isValid = false;
    }

    if (!fecha) {
        document.getElementById("Datereserva").classList.add('input-error');
        document.getElementById("errorNombre2").style.display = 'block';
        isValid = false;
    }

    if (!hora) {
        document.getElementById("hora-reserva").classList.add('input-error');
        document.getElementById("errorHora").style.display = 'block';
        isValid = false;
    }

    if (!isValid) return;

    // ‚úÖ Validar disponibilidad de horario
    const mesa = document.getElementById("select-mesa").value;
    const duracion = parseInt(document.getElementById("duracion-reserva").value);
    if (!validarHorarioReserva(mesa, fecha, hora, duracion)) {
        Swal.fire({
            icon: 'error',
            title: 'Horario no disponible',
            text: 'La mesa ya est√° reservada en ese horario.'
        });
        return;
    }

    // ‚è∞ Crear objeto reserva
    const reserva = {
        id: document.getElementById("idreserva").value,
        mesa,
        cliente: nombre,
        personas,
        fecha,
        hora,
        duracion,
        ocasion: document.getElementById("ocasiones-especiales").value,
        notas: document.getElementById("Notas").value,
        estado: "Pendiente",
        startTime: new Date(`${fecha}T${hora}`).getTime()
    };

    // üíæ Guardar reserva
    datos.push(reserva);

    // ‚úÖ Actualizar UI y temporizador
    iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
    localStorage.setItem("reservas", JSON.stringify(datos));
    pintarDatos();
    pintarDatosNew();
    actualizarEstadisticas();
    limpiarFormularioNew();

    // ‚úÖ Cerrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    Swal.fire({
        title: "Reserva guardada correctamente",
        icon: "success",
        timer: 2000,
        showConfirmButton: false
    });
setTimeout(() => {
    pintarDatos();
    pintarDatosNew();
    actualizarEstadisticas();
}, 50);
}

//       function guardarNew() {
//     // ‚úÖ Validaciones b√°sicas
//     let isValid = true;

//     if (!document.getElementById("nombreCliente").value.trim()) {
//         document.getElementById("nombreCliente").classList.add('input-error');
//         document.getElementById("errorNombre").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
//         document.getElementById("NumReservas").classList.add('input-error');
//         document.getElementById("errorNombre1").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("Datereserva").value) {
//         document.getElementById("Datereserva").classList.add('input-error');
//         document.getElementById("errorNombre2").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("hora-reserva").value) {
//         document.getElementById("hora-reserva").classList.add('input-error');
//         document.getElementById("errorHora").style.display = 'block';
//         isValid = false;
//     }

//     if (!isValid) return;

//     // ‚úÖ Validaci√≥n de horario (8am - 23:59)
//     const horaSeleccionada = document.getElementById("hora-reserva").value;
//     const horaNum = parseInt(horaSeleccionada.split(':')[0]);
//     const minNum = parseInt(horaSeleccionada.split(':')[1]);

//     if (horaNum < 8 || (horaNum === 23 && minNum > 59) || horaNum > 23) {
//         Swal.fire({
//             icon: 'error',
//             title: 'Horario no v√°lido',
//             text: 'El horario debe estar entre 8:00 am y 23:59 pm'
//         });
//         return;
//     }

//     // ‚úÖ Validaci√≥n de conflictos de horario (solo nuevas)
//     const mesa = document.getElementById("select-mesa").value;
//     const fecha = document.getElementById("Datereserva").value;
//     const hora = document.getElementById("hora-reserva").value;
//     const duracion = parseInt(document.getElementById("duracion-reserva").value);

//     if (editIndexReserva === null) {
//         if (!validarHorarioReserva(mesa, fecha, hora, duracion)) {
//             Swal.fire({
//                 icon: 'error',
//                 title: 'Horario no disponible',
//                 text: 'La mesa ya est√° reservada en ese horario. Por favor, elija otro horario o mesa.'
//             });
//             return;
//         }
//     }

//     // üìå Calcular startTime
//     const startTimestamp = new Date(`${fecha}T${hora}`).getTime();

//     // ‚úÖ Generar ID autom√°tico solo si es nueva reserva
//     let idReserva = editIndexReserva === null ? obtenerSiguienteIdReserva() : document.getElementById("idreserva").value;

//     // ‚úÖ Crear objeto reserva
//     const reserva = {
//         id: idReserva,
//         mesa,
//         cliente: document.getElementById("nombreCliente").value,
//         personas: document.getElementById("NumReservas").value,
//         fecha,
//         hora,
//         duracion,
//         ocasion: document.getElementById("ocasiones-especiales").value,
//         notas: document.getElementById("Notas").value,
//         estado: document.getElementById("estado").value,
//         startTime: startTimestamp
//     };

//     // üíæ Guardar (nueva o edici√≥n)
//     if (editIndexReserva === null) {
//         datos.push(reserva); // nueva reserva
//     } else {
//         datos[editIndexReserva] = reserva; // edici√≥n
//         editIndexReserva = null;
//     }

//     // ‚úÖ Iniciar temporizador si la reserva est√° confirmada
//     if (reserva.estado === "Confirmada") {
//         iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
//     }

//     // üíæ Guardar en localStorage y refrescar UI
//     localStorage.setItem("reservas", JSON.stringify(datos));
//     pintarDatos();
//     pintarDatosNew();
//     actualizarEstadisticas();
//     limpiarFormularioNew();



//     const modal = bootstrap.Modal.getInstance(document.getElementById("modalReservas"));
//     modal.hide();



//     Swal.fire({
//         title: "Reserva guardada correctamente",
//         icon: "success",
//         timer: 3000,
//         showConfirmButton: false
//     });
// }

// Funci√≥n para generar ID autom√°tico
function obtenerSiguienteIdReserva() {
    if (datos.length === 0) return 1;
    const maxId = Math.max(...datos.map(r => Number(r.id)));
    return maxId > 0 ? maxId + 1 : 1;
}


        function limpiarFormularioNew() {
            document.getElementById("idreserva").value = "";
            document.getElementById("nombreCliente").value = "";
            document.getElementById("NumReservas").value = "";
            document.getElementById("Datereserva").value = "";
            document.getElementById("hora-reserva").value = "";
            document.getElementById("Notas").value = "";
            document.getElementById("estado").value = "Confirmada";
            document.getElementById("select-mesa").value = "";
            
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
        }
function pintarDatosNew() {
    const infoData = document.getElementById("infoData");
    const filtroConfirmadas = document.getElementById("filtroConfirmadas");

    const fechaSeleccionada = document.getElementById("filtroFecha")?.value || "";
    const estadoSeleccionado = document.getElementById("filtroEstado")?.value || "";

    infoData.innerHTML = "";
    filtroConfirmadas.innerHTML = "";

    // Aplicar filtros
    let reservasFiltradas = datos;

    if (fechaSeleccionada) {
        reservasFiltradas = reservasFiltradas.filter(item => item.fecha === fechaSeleccionada);
    }

    if (estadoSeleccionado) {
        reservasFiltradas = reservasFiltradas.filter(item => item.estado === estadoSeleccionado);
    }

    // Si no hay resultados
    if (reservasFiltradas.length === 0) {
        infoData.innerHTML = `<tr><td colspan="12" class="text-center">No hay reservas con los filtros aplicados</td></tr>`;
        return;
    }

    reservasFiltradas.forEach(item => {
        // Actualizar estado de la mesa seg√∫n reserva
        const mesaEncontrada = mesas.find(m => m.numero == item.mesa);
        if (mesaEncontrada) {
            if (item.estado === "Confirmada") {
                mesaEncontrada.estado = "Ocupada";
            } else if (item.estado === "Pendiente") {
                mesaEncontrada.estado = "Libre";
            } else if (["Finalizada", "Cancelada"].includes(item.estado)) {
                mesaEncontrada.estado = "Libre";
            }
        }

        // Iniciar temporizador para pendientes o confirmadas
        if ((item.estado === "Pendiente" || item.estado === "Confirmada") && item.fecha && item.hora) {
            if (!item.startTime) item.startTime = new Date(`${item.fecha}T${item.hora}`).getTime();
            iniciarTemporizador(item.id, item.startTime, item.duracion);
        }

        // Crear fila de tabla con temporizador
        let tr = document.createElement("tr");
        if (item.estado === "Confirmada") tr.classList.add("reserva-activa");

        let tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;

        tr.innerHTML = `
            <td>${item.id}</td>
            <td>${item.mesa}</td>
            <td>${item.cliente}</td>
            <td>${item.personas}</td>
            <td>${item.fecha}</td>
            <td>${item.hora || '-'}</td>
            <td>${item.duracion ? item.duracion + ' h' : '-'}</td>
            <td>${item.ocasion}<br>${getImagenPorOcasion(item.ocasion)}</td>
            <td>${item.notas}</td>
            <td>
                <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
                                    item.estado === 'Pendiente' ? 'bg-warning' : 
                                    item.estado === 'Cancelada' ? 'bg-danger' : 'bg-secondary'}">
                    ${item.estado}
                </span>
            </td>
            ${tiempoInfo}
            <td>
                ${item.estado !== 'Finalizada' ? 
                    `<button class="btn btn-warning btn-sm" onclick="editarReservaNew(${datos.findIndex(d => d.id === item.id)})">‚úèÔ∏è Editar</button>` 
                    : ''}
                <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${datos.findIndex(d => d.id === item.id)})">üóëÔ∏è Eliminar</button>
                ${item.estado === 'Confirmada' ? 
                    `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${datos.findIndex(d => d.id === item.id)})">üíµ Pagar</button>` 
                    : ''}
            </td>
        `;
        infoData.appendChild(tr);

        // Tarjetas visuales para reservas activas
        if (item.estado === "Confirmada") {
            let div = document.createElement("div");
            div.classList.add("card", "p-2", "mb-2", "border", "rounded", "border-danger");
            div.style.background = "linear-gradient(to right, #ff4b1f, #ff9068)"; // rojo
            div.innerHTML = `
                <h4 style="color:white;">Mesa ocupada</h4>
                <strong>Mesa:</strong> ${item.mesa} |
                <strong>Cliente:</strong> ${item.cliente} |
                <strong>Hora:</strong> ${item.hora}
            `;
            filtroConfirmadas.appendChild(div);
        }
    });

    // Guardar cambios de mesas
    localStorage.setItem("mesas", JSON.stringify(mesas));
    actualizarSelectMesas();
}



//         function pintarDatosNew() {
//             const infoData = document.getElementById("infoData");
//             const filtroConfirmadas = document.getElementById("filtroConfirmadas");

//             const fechaSeleccionada = document.getElementById("filtroFecha")?.value || "";
//             const estadoSeleccionado = document.getElementById("filtroEstado")?.value || "";

//             infoData.innerHTML = "";         
//             filtroConfirmadas.innerHTML = ""; 

//             // üîé Aplicar filtros
//             let reservasFiltradas = datos;

//             if (fechaSeleccionada) {
//                 reservasFiltradas = reservasFiltradas.filter(item => item.fecha === fechaSeleccionada);
//             }

//             if (estadoSeleccionado) {
//                 reservasFiltradas = reservasFiltradas.filter(item => item.estado === estadoSeleccionado);
//             }

//             // Si no hay resultados
//             if (reservasFiltradas.length === 0) {
//                 infoData.innerHTML = `<tr><td colspan="12" class="text-center">No hay reservas con los filtros aplicados</td></tr>`;
//                 return;
//             }

//             reservasFiltradas.forEach((item, i) => {
//                 let tr = document.createElement("tr");
//                 if (item.estado === "Confirmada") {
//         const mesaEncontrada = mesas.find(m => m.numero == item.mesa);
//         if (mesaEncontrada && mesaEncontrada.estado !== "Ocupada") {
//             mesaEncontrada.estado = "Ocupada";
//         }
//     }


//                 // Calcular tiempo
//                 let tiempoInfo = "";
//                 if (item.startTime && item.estado === "Confirmada") {
//                     tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;
//                 } else {
//                     tiempoInfo = "<td>-</td>";
//                 }

//                 tr.innerHTML = `
//                     <td>${item.id}</td>
//                     <td>${item.mesa}</td>
//                     <td>${item.cliente}</td>
//                     <td>${item.personas}</td>
//                     <td>${item.fecha}</td>
//                     <td>${item.hora || '-'}</td>
//                     <td>${item.duracion ? item.duracion + ' h' : '-'}</td>
//                     <td>${item.ocasion}<br>${getImagenPorOcasion(item.ocasion)}</td>
//                     <td>${item.notas}</td>
//                     <td>
//                         <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
//                                         item.estado === 'Pendiente' ? 'bg-warning' : 
//                                         item.estado === 'Cancelada' ? 'bg-danger' : 'bg-secondary'}">
//                             ${item.estado}
//                         </span>
//                     </td>
//                     ${tiempoInfo}
//                     <td>
//                         ${item.estado !== 'Finalizada' ? 
//                             `<button class="btn btn-warning btn-sm" onclick="editarReservaNew(${datos.findIndex(d => d.id === item.id)})">‚úèÔ∏è Editar</button>` 
//                             : ''}
//                         <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${datos.findIndex(d => d.id === item.id)})">üóëÔ∏è Eliminar</button>
//                         ${item.estado === 'Confirmada' ? 
//                             `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${datos.findIndex(d => d.id === item.id)})">üíµ Pagar</button>` 
//                             : ''}
//                     </td>
//                 `;
//                 infoData.appendChild(tr);

//                 // Tarjetas para reservas activas
// // Tarjetas para reservas activas
// if (item.estado === "Confirmada") {
//     let div = document.createElement("div");
//     div.classList.add("card", "p-2", "mb-2", "border", "rounded", "border-danger");
//     div.style.background = "linear-gradient(to right, #ff4b1f, #ff9068)"; // üî¥ degradado rojo

//     div.innerHTML = `
//         <h4 style="color:white;">Mesa ocupada</h4>
//         <strong>Mesa:</strong> ${item.mesa} |
//         <strong>Cliente:</strong> ${item.cliente} |
//         <strong>Hora:</strong> ${item.hora}
//     `;
//     filtroConfirmadas.appendChild(div);
// }

//             });
//         }

        // function editarReservaNew(i) {
        //     let item = datos[i];

        //     document.getElementById("idreserva").value = item.id;
        //     document.getElementById("select-mesa").value = item.mesa;
        //     document.getElementById("nombreCliente").value = item.cliente;
        //     document.getElementById("NumReservas").value = item.personas;
        //     document.getElementById("Datereserva").value = item.fecha;
        //     document.getElementById("hora-reserva").value = item.hora || "";
        //     document.getElementById("duracion-reserva").value = item.duracion;
        //     document.getElementById("ocasiones-especiales").value = item.ocasion;
        //     document.getElementById("Notas").value = item.notas;
        //     document.getElementById("estado").value = item.estado;

        //     const modal = new bootstrap.Modal(document.getElementById("modalReservas"));
        //     modal.show();

        //     editIndexReserva = i;
        // }




// Funci√≥n que abre el modal con datos para editar
function editarReservaNew(i) {
    let item = datos[i];

    document.getElementById("idreserva").value = item.id;
    document.getElementById("select-mesa").value = item.mesa;
    document.getElementById("nombreCliente").value = item.cliente;
    document.getElementById("NumReservas").value = item.personas;
    document.getElementById("Datereserva").value = item.fecha;
    document.getElementById("hora-reserva").value = item.hora || "";
    document.getElementById("duracion-reserva").value = item.duracion;
    document.getElementById("ocasiones-especiales").value = item.ocasion;
    document.getElementById("Notas").value = item.notas;
    document.getElementById("estado").value = item.estado;

    // Mostrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    editIndexReserva = i;

    // Crear bot√≥n "Guardar cambios" din√°micamente
    let footer = modalEl.querySelector(".modal-footer");
    
    // Limpiar cualquier bot√≥n anterior
    footer.innerHTML = "";

    const btnGuardar = document.createElement("button");
    btnGuardar.className = "btn btn-primary";
    btnGuardar.textContent = "Guardar cambios";
    btnGuardar.onclick = guardarCambiosReserva; // funci√≥n que actualiza los datos

    footer.appendChild(btnGuardar);
}

function guardarCambiosReserva() {
    if (editIndexReserva === null) return; // no hay reserva seleccionada

    // Actualizar datos
    datos[editIndexReserva] = {
        id: document.getElementById("idreserva").value,
        mesa: document.getElementById("select-mesa").value,
        cliente: document.getElementById("nombreCliente").value,
        personas: document.getElementById("NumReservas").value,
        fecha: document.getElementById("Datereserva").value,
        hora: document.getElementById("hora-reserva").value,
        duracion: document.getElementById("duracion-reserva").value,
        ocasion: document.getElementById("ocasiones-especiales").value,
        notas: document.getElementById("Notas").value,
        estado: document.getElementById("estado").value,
        startTime: new Date(`${document.getElementById("Datereserva").value}T${document.getElementById("hora-reserva").value}`).getTime()
    };

    // Guardar en localStorage
    localStorage.setItem("reservas", JSON.stringify(datos));

    // Cerrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    // Limpiar √≠ndice
    editIndexReserva = null;

    // üîÑ Refrescar UI y temporizadores
    pintarDatosNew();
    actualizarEstadisticas();
    recuperarTemporizadores();
}
// Funci√≥n para guardar cambios
// function guardarCambiosReserva() {
//     if (editIndexReserva === null) return; // no hay reserva seleccionada

//     // Actualizar el array 'datos' con los valores del formulario
//     datos[editIndexReserva] = {
//         id: document.getElementById("idreserva").value,
//         mesa: document.getElementById("select-mesa").value,
//         cliente: document.getElementById("nombreCliente").value,
//         personas: document.getElementById("NumReservas").value,
//         fecha: document.getElementById("Datereserva").value,
//         hora: document.getElementById("hora-reserva").value,
//         duracion: document.getElementById("duracion-reserva").value,
//         ocasion: document.getElementById("ocasiones-especiales").value,
//         notas: document.getElementById("Notas").value,
//         estado: document.getElementById("estado").value
//     };

//     // Opcional: cerrar modal
//     const modalEl = document.getElementById("modalReservas");
//     const modal = bootstrap.Modal.getInstance(modalEl);
//     modal.hide();

//     // Limpiar √≠ndice
//     editIndexReserva = null;

//     // Refrescar la tabla o lista de reservas en pantalla
//     renderTablaReservas();
// }

        function eliminarReservaNew(i) {
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: "Esta acci√≥n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Detener temporizador si est√° activo
                    const reservaId = datos[i].id;
                    if (temporizadoresActivos[reservaId]) {
                        clearInterval(temporizadoresActivos[reservaId]);
                        delete temporizadoresActivos[reservaId];
                    }

                    // üóëÔ∏è Eliminar la reserva
                    datos.splice(i, 1);
                    localStorage.setItem("reservas", JSON.stringify(datos));

                    // Refrescar interfaz
                    pintarDatosNew();
                    actualizarEstadisticas();

                    Swal.fire('Eliminada!', 'La reserva ha sido eliminada.', 'success');
                }
            });
        }

        function pagarCuenta(i) {
            let item = datos[i];
            item.estado = "Finalizada";
            
            // Detener temporizador si est√° activo
            if (temporizadoresActivos[item.id]) {
                clearInterval(temporizadoresActivos[item.id]);
                delete temporizadoresActivos[item.id];
            }
            
            localStorage.setItem("reservas", JSON.stringify(datos));
            pintarDatosNew();
            actualizarEstadisticas();
            
            Swal.fire(`La cuenta de ${item.cliente} (Mesa ${item.mesa}) ha sido pagada ‚úÖ`, '', 'success');
        }

        function actualizarEstadisticas() {
            document.getElementById("total-mesas").textContent = mesas.length;
            document.getElementById("mesas-libres").textContent = mesas.filter(m => m.estado === "Libre").length;
            document.getElementById("total-reservas").textContent = datos.length;
            
            // Mostrar reservas de hoy
            const today = new Date().toISOString().split('T')[0];
            const reservasHoy = datos.filter(r => r.fecha === today);
            const reservasHoyContainer = document.getElementById("reservas-hoy");
            
            if (reservasHoy.length === 0) {
                reservasHoyContainer.innerHTML = '<div class="text-center p-3 border rounded">No hay reservas para hoy</div>';
            } else {
                let html = '';
                reservasHoy.forEach(r => {
                    html += `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>Mesa ${r.mesa}</strong>
                                <span class="badge ${r.estado === 'Confirmada' ? 'bg-success' : 'bg-warning'}">${r.estado}</span>
                            </div>
                            <div>${r.cliente} (${r.personas} personas)</div>
                            <div>Hora: ${r.hora}</div>
                            <small class="text-muted">${r.ocasion}</small>
                        </div>
                    `;
                });
                reservasHoyContainer.innerHTML = html;
            }
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener("DOMContentLoaded", function() {
            pintarDatos();
            pintarDatosNew();
            actualizarEstadisticas();
            recuperarTemporizadores();
            document.getElementById("btnGuardarModal").addEventListener("click", guardarDesdeModal);
        });
    </script>
</body>
</html>

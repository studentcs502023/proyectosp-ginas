<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Mesas y Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--secondary-color);
        }
        
        .card-mesa:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa.libre {
    background-color: var(--success-color);
}

.card-mesa.ocupada {
    background-color: var(--accent-color);
}

.card-mesa.deshabilitada {
    background-color: #95a5a6;
}
        
        .estado-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .estado-libre {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .estado-ocupada {
            background-color: #ffebee;
            color: var(--accent-color);
        }
        
        .estado-deshabilitada {
            background-color: #f5f5f5;
            color: #9e9e9e;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-error {
            border: 1px solid var(--accent-color) !important;
        }
        
        .error-message {
            color: var(--accent-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .temporizador-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .temporizador-activo {
            color: #dc3545;
            font-weight: bold;
        }
        #filtroFecha{
            width: 20vw;
       
        }

        .ocasion-img {
  height: 80px;
  width: 80px;
  display: inline-block;
  object-fit: contain;
  vertical-align: middle;
}


        
        @media (max-width: 768px) {
            .mesas-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1>üçΩÔ∏è Sistema de Gesti√≥n de Mesas</h1>
        <p class="lead">Administra tus mesas y reservas de forma eficiente</p>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Mesas Disponibles</h2>
                    <button type="button" class="btn btn-primary-custom text-white" data-bs-toggle="modal" data-bs-target="#modalMesas">
                        + Agregar Mesa
                    </button>
                </div>
           
                <div id="bodyData" class="mesas-grid"></div>
     <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Gesti√≥n de Reservas</h2>
                        <button id="btnReserva" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalReservas">
                            ‚ûï Hacer Reserva
                        </button>
                    </div>
                   <div class="modal fade" id="modalReservas" tabindex="-1" aria-labelledby="modalReservasLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalReservasLabel">Registro de Reserva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="idreserva" class="form-label">ID √∫nico de la reserva</label>
                            <input type="number" id="idreserva" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="select-mesa" class="form-label">Seleccione una mesa</label>
                            <select id="select-mesa" class="form-select" required>
                                <option value="">Seleccione una mesa</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="nombreCliente" class="form-label">Nombre del cliente</label>
                            <input type="text" id="nombreCliente" class="form-control" required>
                            <div id="errorNombre" class="error-message">‚ö†Ô∏è El nombre es obligatorio</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="NumReservas" class="form-label">N√∫mero de personas</label>
                            <input type="number" id="NumReservas" class="form-control" required min="1">
                            <div id="errorNombre1" class="error-message">‚ö†Ô∏è El n√∫mero de personas es obligatorio</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="Datereserva" class="form-label">Fecha de reserva</label>
                            <input type="date" id="Datereserva" class="form-control">
                            <div id="errorNombre2" class="error-message">‚ö†Ô∏è La fecha es obligatoria</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="hora-reserva" class="form-label">Hora de reserva</label>
                            <input type="time" id="hora-reserva" class="form-control" min="08:00" max="20:00">
                            <div id="errorHora" class="error-message">‚ö†Ô∏è La hora es obligatoria (entre 8:00 y 20:00)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="duracion-reserva" class="form-label">Duraci√≥n estimada</label>
                            <select id="duracion-reserva" class="form-select">
                                <option value="60">1 hora</option>
                                <option value="120" selected>2 horas</option>
                                <option value="180">3 horas</option>
                                <option value="240">4 horas</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ocasiones-especiales" class="form-label">Ocasi√≥n especial</label>
                            <select id="ocasiones-especiales" class="form-select">
                                <option value="cumplea√±os">Cumplea√±os</option>
                                <option value="Aniversario">Aniversario</option>
                                <option value="Reunion de Negocios">Reuni√≥n de Negocios</option>
                                <option value="Boda">Boda</option>
                                <option value="Despedida">Despedida</option>
                                <option value="Graduacion">Graduaci√≥n</option>
                                <option value="Compromiso">Compromiso</option>
                                <option value="Dia de la Madre">D√≠a de la Madre</option>
                                <option value="Dia del Padre">D√≠a del Padre</option>
                                <option value="San Valentin">San Valent√≠n</option>
                                <option value="Navidad">Navidad</option>
                                <option value="A√±o Nuevo">A√±o Nuevo</option>
                            </select>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="Notas" class="form-label">Notas para la atenci√≥n</label>
                            <textarea id="Notas" class="form-control" rows="2"></textarea>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="estado" class="form-label">Estado de la reserva</label>
                            <select id="estado" class="form-select">
                                <option value="Pendiente">Pendiente</option>
                                <option value="Confirmada">Confirmada</option>
                                <option value="Cancelada">Cancelada</option>
                                <option value="Finalizada">Finalizada</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="save" onclick="guardarNew()" class="btn btn-primary-custom text-white">Guardar</button>
                </div>
            </div>
        </div>
    </div>
                    

<div class="row mt-4">
  <div class="col-md-4">
    <label for="filtroFecha" class="form-label">Filtrar por fecha</label>
    <input type="date" id="filtroFecha" class="form-control" onchange="pintarDatosNew()">
  </div>
</div>

  <div class="col-md-4">
    <label for="filtroEstado" class="form-label">Filtrar por estado</label>
    <select id="filtroEstado" class="form-control" onchange="pintarDatosNew()">
      <option value="">-- Todos --</option>
      <option value="Confirmada">Confirmada</option>
      <option value="Pendiente">Pendiente</option>
      <option value="Ocupada">Ocupada</option>
      <option value="Cancelada">Cancelada</option>
      <option value="Finalizada">Finalizada</option>
    </select>
  </div>
</div>
                    <div class="mt-5">
                        <h3 class="mb-3">Reservas Existentes</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-custom">
                                <thead>
                                    <tr>
                                      <th>ID</th>
                                        <th>Mesa</th>
                                        <th>Cliente</th>
                                        <th>Personas</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Duraci√≥n</th>
                                        <th>Ocasi√≥n</th>
                                        <th>Notas</th>
                                        <th>Estado</th>
                                        <th>Tiempo</th>
                                        <th>Opciones</th>
  <td>
    <span id="temporizador-${reserva.id}">‚åõ</span>
  </td>
                                    </tr>
                                </thead>
                                <tbody id="infoData"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="form-container">
                    <h3>Estad√≠sticas</h3>
                    <div class="d-flex justify-content-around text-center my-4">
                        <div>
                            <div class="fs-1 fw-bold" id="total-mesas">0</div>
                            <div>Total Mesas</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="mesas-libres">0</div>
                            <div>Mesas Libres</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="total-reservas">0</div>
                            <div>Total Reservas</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4>Reservas de Hoy</h4>
                        <div id="reservas-hoy" class="mt-3">
                            <!-- Las reservas de hoy se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    <div class="filter mt-4">
                        <h4>Reservas ocupadas y pendientes</h4>
                        <div id="filtroConfirmadas"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar mesas -->
    <div class="modal fade" id="modalMesas" tabindex="-1" aria-labelledby="modalMesasLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMesasLabel">Agregar mesa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-numero" class="form-label">N√∫mero de mesa</label>
                        <input type="number" id="modal-numero" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modal-cantidad" class="form-label">Cantidad de personas</label>
                        <input type="number" id="modal-cantidad" class="form-control" required min="1">
                        <div id="errorCantidad" class="error-message">‚ö†Ô∏è La cantidad debe ser mayor a 0</div>
                    </div>
                    <div class="mb-3">
                        <label for="modal-ubicacion" class="form-label">Ubicaci√≥n</label>
                        <input type="text" id="modal-ubicacion" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-estado" class="form-label">Estado</label>
                        <select id="modal-estado" class="form-select">
                            <option value="Libre">Libre</option>
                            <option value="Deshabilitada">Deshabilitada</option>
                            <option value="Ocupada">Ocupada</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom text-white" id="btnGuardarModal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

   
<!-- <div class="row mt-4">
  <div class="col-md-4">
    <label for="filtroFecha" class="form-label">Filtrar por fecha</label>
    <input type="date" id="filtroFecha" class="form-control" onchange="filtrarReservasPorFecha()">
  </div>
</div>

 Tabla de resultados filtrados -->
<!-- <div class="table-responsive mt-3">
  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <th>Mesa</th>
        <th>Cliente</th>
        <th>Personas</th>
        <th>Fecha</th>
        <th>Duraci√≥n</th>
        <th>Ocasi√≥n</th>
        <th>imagen</th>
        <th>Notas</th>
        <th>Estado</th>
        <th>Opciones</th>
      </tr>
    </thead>
    <tbody id="contenedorReservasFiltradas">
     
    </tbody>
  </table>
</div> --> 



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("Datereserva");

    // üëâ Establecer la fecha m√≠nima (hoy)
    const hoy = new Date().toISOString().split("T")[0];
    fechaInput.setAttribute("min", hoy);

    // üëâ Validaci√≥n: si intentan poner una fecha pasada manualmente
    fechaInput.addEventListener("change", () => {
      if (fechaInput.value < hoy) {
        alert("‚ö†Ô∏è No puedes seleccionar una fecha pasada.");
        fechaInput.value = hoy; // Resetear a hoy
      }
    });
  });


        function getImagenPorOcasion(ocasion) {
    const imagenes = {
        "cumplea√±os": "https://png.pngtree.com/png-vector/20240816/ourmid/pngtree-colorful-balloon-happy-birthday-text-with-festive-decorations-png-image_13507141.png",
        "Aniversario": "https://i.imgur.com/IkqU7J7.png",
        "Reunion de Negocios": "https://i.imgur.com/6vE6pcv.png",
        "Boda": "https://i.imgur.com/3ny2rTh.png",
        "Despedida": "https://i.imgur.com/9W3mEoW.png",
        "Graduacion": "https://i.imgur.com/MZAkSUO.png",
        "Compromiso": "https://i.imgur.com/EjZqvQ7.png",
        "Dia de la Madre": "https://i.imgur.com/r4C6eo9.png",
        "Dia del Padre": "https://i.imgur.com/t0O6dVZ.png",
        "San Valentin": "https://i.imgur.com/EGZ1hdV.png",
        "Navidad": "https://i.imgur.com/Ia0JODJ.png",
        "A√±o Nuevo": "https://i.imgur.com/Nxj3hRP.png"
    };

    const src = imagenes[ocasion];
    return src ? `<img src="${src}" alt="${ocasion}" style="height: 20px; margin-right: 6px;">` : "";
}


function filtrarReservasPorFecha() {
  const fechaSeleccionada = document.getElementById("filtroFecha").value;

  if (!fechaSeleccionada) {
    document.getElementById("contenedorReservasFiltradas").innerHTML = "";
    return;
  }

  const resultados = datos.filter(r =>
    r.fecha === fechaSeleccionada &&
    ["Ocupada", "Confirmada", "Finalizada", "Pendiente"].includes(r.estado)
  );

  pintarResultadosFiltrados(resultados);
}

function pintarResultadosFiltrados(reservasFiltradas) {
  const contenedor = document.getElementById("contenedorReservasFiltradas");
  contenedor.innerHTML = "";

  reservasFiltradas.forEach((item, i) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${item.mesa}</td>
      <td>${item.cliente}</td>
      <td>${item.personas}</td>
      <td>${item.fecha}</td>
      <td>${item.duracion ? (item.duracion / 60) + ' h' : '-'}</td>
      <td>${item.ocasion}</td>
      <td>${item.notas}</td>
      <td><span class="badge bg-${item.estado === "Confirmada" ? "success" : item.estado === "Ocupada" ? "primary" : "secondary"}">${item.estado}</span></td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editarReservaNew(${buscarIndicePorId(item.id)})">‚úèÔ∏è Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminarReservaNew(${buscarIndicePorId(item.id)})">üóëÔ∏è Eliminar</button>
      </td>
    `;

    contenedor.appendChild(tr);
  });
}

// Para obtener el √≠ndice real del item en 'datos' al usar id
function buscarIndicePorId(id) {
  return datos.findIndex(r => r.id == id);
}
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("filtroFecha").value = today;
  filtrarReservasPorFecha();
});




        // Inicializar localStorage
        if (!localStorage.getItem("mesas")) {
            localStorage.setItem("mesas", JSON.stringify([]));
        }
        
        if (!localStorage.getItem("reservas")) {
            localStorage.setItem("reservas", JSON.stringify([]));
        }

        let mesas = JSON.parse(localStorage.getItem("mesas"));
        let datos = JSON.parse(localStorage.getItem("reservas"));
        let editIndex = null;
        let temporizadoresActivos = {};

        // ==================== FUNCIONES DEL TEMPORIZADOR ====================

// ‚úÖ Al cargar la p√°gina
window.onload = function () {
    // 1. Recuperar reservas desde localStorage
    if (localStorage.getItem("reservas")) {
        datos = JSON.parse(localStorage.getItem("reservas"));
    }

    // 2. Recuperar mesas desde localStorage
    if (localStorage.getItem("mesas")) {
        mesas = JSON.parse(localStorage.getItem("mesas"));
    }

    // 3. Pintar datos en la interfaz
    pintarDatos();       // mesas
    pintarDatosNew();    // reservas
    actualizarEstadisticas();

    // 4. Reactivar temporizadores si la reserva sigue activa
    recuperarTemporizadores();
};

function recuperarTemporizadores() {
    datos.forEach(reserva => {
        if (
            reserva.startTime &&
            reserva.duracion &&
            (reserva.estado === "Confirmada" || 
             reserva.estado === "Ocupada" || 
             reserva.estado === "Pendiente")
        ) {
            iniciarTemporizador(reserva.id, parseInt(reserva.startTime), parseInt(reserva.duracion));
        }
    });}


function validarHorarioReserva(mesa, fecha, hora, duracion, reservaId = null) {
    // ‚úÖ Duraci√≥n en milisegundos
    const duracionMs = duracion * 60000;

    // üîπ Calcular inicio y fin de la nueva reserva
    const nuevaReservaInicio = new Date(`${fecha}T${hora}`);
    const nuevaReservaFin = new Date(nuevaReservaInicio.getTime() + duracionMs);

    // üîπ Definir rango permitido (08:00 ‚Üí 20:00)
    const apertura = new Date(`${fecha}T08:00`);
    const cierre = new Date(`${fecha}T20:00`);

    // ‚ùå Si est√° fuera del horario permitido ‚Üí inv√°lida
    if (nuevaReservaInicio < apertura || nuevaReservaFin > cierre) {
        return false;
    }

    // üîπ Validar contra reservas existentes
    return !datos.some(reserva => {
        // 1. Misma mesa (excluyendo la que se est√° editando)
        if (reserva.mesa != mesa) return false;
        if (reservaId && reserva.id == reservaId) return false;

        // 2. Misma fecha
        if (reserva.fecha != fecha) return false;

        // 3. Saltar canceladas/finalizadas
        
        

        // 4. Calcular rango de reserva existente
        const reservaExistenteInicio = new Date(`${reserva.fecha}T${reserva.hora}`);
        const reservaExistenteFin = new Date(reservaExistenteInicio.getTime() + (reserva.duracion * 60000));

        // 5. Verificar solapamiento
        const hayConflicto = nuevaReservaInicio < reservaExistenteFin &&
                             nuevaReservaFin > reservaExistenteInicio;

        return hayConflicto;
    });
}


        
        // Iniciar temporizador para una reserva
        // function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
        //     // Limpiar temporizador existente si hay uno
        //     if (temporizadoresActivos[reservaId]) {
        //         clearInterval(temporizadoresActivos[reservaId]);
        //     }
            
        //     const ahora = Date.now();
        //     const tiempoTranscurrido = Math.floor((ahora - startTime) / 6000); // en minutos
            
        //     // Si ya pas√≥ el tiempo l√≠mite
        //     if (tiempoTranscurrido >= duracionMinutos) {
        //         document.querySelector(`#temporizador-${reservaId}`).innerHTML = 
        //             `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
        //         return;
        //     }
            
        //     // Actualizar contador inmediatamente
        //     actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
            
        //     // Configurar intervalo para actualizar cada minuto
        //     temporizadoresActivos[reservaId] = setInterval(() => {
        //         actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
        //     }, 6);
        // }
function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
    if (temporizadoresActivos[reservaId]) {
        clearInterval(temporizadoresActivos[reservaId]);
    }

    temporizadoresActivos[reservaId] = setInterval(() => {
        const ahora = Date.now();
        let reserva = datos.find(r => r.id === reservaId);

        if (!reserva) return;

        // ‚è∞ Cambiar Pendiente ‚Üí Ocupada al llegar la hora
        if (reserva.estado === "Pendiente" && ahora >= startTime) {
            reserva.estado = "Ocupada";

            let mesa = mesas.find(m => m.numero == reserva.mesa);
            if (mesa) mesa.estado = "Ocupada";

            localStorage.setItem("reservas", JSON.stringify(datos));
            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatosNew();
            pintarDatos();
        }

        // Si ya est√° ocupada, calculamos tiempo restante
        if (reserva.estado === "Ocupada" || reserva.estado === "Confirmada") {
            const fin = startTime + duracionMinutos * 60000;
            const tiempoRestante = fin - ahora;

            if (tiempoRestante <= 0) {
                document.querySelector(`#temporizador-${reservaId}`).innerHTML =
                    `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
                clearInterval(temporizadoresActivos[reservaId]);
                return;
            }

            actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
        }
    }, 1000);
}

// function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
//     if (temporizadoresActivos[reservaId]) {
//         clearInterval(temporizadoresActivos[reservaId]);
//     }

//     temporizadoresActivos[reservaId] = setInterval(() => {
//         const ahora = Date.now();
//         let reserva = datos.find(r => r.id === reservaId);

//         if (!reserva) return; // si se elimin√≥ la reserva, detenemos el temporizador

//         // ‚è∞ Cambiar Pendiente ‚Üí Ocupada cuando llegue la hora de inicio
//         if (reserva.estado === "Pendiente" && ahora >= startTime) {
//             reserva.estado = "Ocupada";
//             let mesa = mesas.find(m => m.numero === reserva.mesa);
//             if (mesa) mesa.estado = "Ocupada";
//             localStorage.setItem("reservas", JSON.stringify(datos));
//             pintarDatosNew();
//         }

//         // Calcular tiempo restante hasta fin
//         const fin = startTime + duracionMinutos * 60000;
//         const tiempoRestante = fin - ahora;

//         if (tiempoRestante <= 0) {
//             // ‚è≥ Cuando termina, cambiar a "Finalizada"
//             reserva.estado = "Finalizada";
//             let mesa = mesas.find(m => m.numero === reserva.mesa);
//             if (mesa) mesa.estado = "Libre";

//             localStorage.setItem("reservas", JSON.stringify(datos));
//             localStorage.setItem("mesas", JSON.stringify(mesas));

//             document.querySelector(`#temporizador-${reservaId}`).innerHTML =
//                 `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;

//             clearInterval(temporizadoresActivos[reservaId]);
//             delete temporizadoresActivos[reservaId];

//             pintarDatosNew();
//             actualizarEstadisticas();
//             return;
//         }

//         // Actualizar contador visible
//         actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
//     }, 1000);
// }



        // Actualizar visualizaci√≥n del contador
        function actualizarContadorTemporizador(reservaId, startTime, duracionMinutos) {
            const ahora = Date.now();
            const tiempoTranscurrido = Math.floor((ahora - startTime) / 600); // en minutos
            const tiempoRestante = duracionMinutos - tiempoTranscurrido;
            
            const elemento = document.querySelector(`#temporizador-${reservaId}`);
            if (!elemento) return;
            
            if (tiempoRestante <= 0) {
                elemento.innerHTML = `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
                clearInterval(temporizadoresActivos[reservaId]);
                delete temporizadoresActivos[reservaId];
                
                // Cambiar estado a "Finalizada" cuando se cumple el tiempo
                const reservaIndex = datos.findIndex(r => r.id == reservaId);
                if (reservaIndex !== -1) {
                    datos[reservaIndex].estado = "Finalizada";
                    localStorage.setItem("reservas", JSON.stringify(datos));
                    
                    // Liberar la mesa
                    const mesaIndex = mesas.findIndex(m => m.numero == datos[reservaIndex].mesa);
                    if (mesaIndex !== -1) {
                        mesas[mesaIndex].estado = "Libre";
                        localStorage.setItem("mesas", JSON.stringify(mesas));
                        pintarDatos();
                    }
                    
                    pintarDatosNew();
                    actualizarEstadisticas();
                }
            } else {
                elemento.innerHTML = `‚åõ ${tiempoRestante} min restantes`;
                
                // Cambiar color si queda poco tiempo (menos de 15 minutos)
                if (tiempoRestante < 15) {
                    elemento.classList.add('temporizador-activo');
                } else {
                    elemento.classList.remove('temporizador-activo');
                }
            }
        }
        
        // Recuperar temporizadores al cargar la p√°gina
        function recuperarTemporizadores() {
            datos.forEach(reserva => {
                if (reserva.startTime && reserva.duracion && 
                    (reserva.estado === "Confirmada" || reserva.estado === "Ocupada" || reserva.estado === "Pendiente")) {
                    iniciarTemporizador(reserva.id, parseInt(reserva.startTime), parseInt(reserva.duracion));
                }
            });
        }
        
        // ==================== FUNCIONES EXISTENTES MODIFICADAS ====================

        // Obtener el siguiente n√∫mero de mesa disponible
        function obtenerSiguienteNumeroMesa() {
            if (mesas.length === 0) return 1;
            const max = Math.max(...mesas.map(m => Number(m.numero)));
            return max > 0 ? max + 1 : 1;
        }

        // Configurar el modal al abrirse
        document.querySelector('[data-bs-target="#modalMesas"]').addEventListener("click", () => {
            editIndex = null;
            document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            document.getElementById("modal-numero").value = obtenerSiguienteNumeroMesa();
            document.getElementById("modal-cantidad").value = "";
            document.getElementById("modal-ubicacion").value = "";
            document.getElementById("modal-estado").value = "Libre";
            
            // Limpiar errores
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
        });

        // Guardar mesa desde el modal
        const guardarDesdeModal = () => {
            const numero = document.getElementById("modal-numero").value;
            const cantidad = document.getElementById("modal-cantidad").value;
            const ubicacion = document.getElementById("modal-ubicacion").value.trim();
            const estado = document.getElementById("modal-estado").value;
            let isValid = true;
            
            // Validaciones
            if (!cantidad || cantidad <= 0) {
                document.getElementById("modal-cantidad").classList.add('input-error');
                document.getElementById("errorCantidad").style.display = 'block';
                isValid = false;
            }
            
            if (!ubicacion) {
                document.getElementById("modal-ubicacion").classList.add('input-error');
                isValid = false;
            }
            
            if (!isValid) return;
            
            if (editIndex === null) {
                const reg = { numero, cantidad, ubicacion, estado };
                mesas.push(reg);
            } else {
                mesas[editIndex].cantidad = cantidad;
                mesas[editIndex].ubicacion = ubicacion;
                mesas[editIndex].estado = estado;
                editIndex = null;
                document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            }

            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatos();
            actualizarEstadisticas();
            
            // Cerrar modal usando Bootstrap
            const modal = bootstrap.Modal.getInstance(document.getElementById("modalMesas"));
            modal.hide();
        };

        // Actualizar el select de mesas disponibles
        function actualizarSelectMesas() {
            const selectMesa = document.getElementById("select-mesa");
            selectMesa.innerHTML = '<option value="">Seleccione una mesa</option>';
            
            mesas.forEach((mesa) => {
                if (mesa.estado === "Libre") {
                    const option = document.createElement("option");
                    option.value = mesa.numero;
                    option.textContent = `Mesa ${mesa.numero} - (${mesa.cantidad} personas)`;
                    selectMesa.appendChild(option);
                }
            });
        }

        // Pintar las mesas en el grid
        const pintarDatos = () => {
            const body = document.getElementById("bodyData");
            body.innerHTML = "";
            
            mesas.forEach((item, i) => {
                const card = document.createElement("div");
                card.className = `card-mesa ${item.estado.toLowerCase()}`;
                
                const estadoClass = `estado-badge estado-${item.estado.toLowerCase()}`;
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4 class="mb-0">Mesa #${item.numero}</h4>
                        <span class="${estadoClass}">${item.estado}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Capacidad:</strong> ${item.cantidad} personas
                    </div>
                    <div class="mb-3">
                        <strong>Ubicaci√≥n:</strong> ${item.ubicacion}
                    </div>
                    <div class="botones d-flex gap-2">
                        <button class="btn btn-sm btn-warning flex-fill" onclick="editarMesa(${i})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-danger flex-fill" onclick="eliminarMesa(${i})">üóëÔ∏è Eliminar</button>
                        ${item.estado !== "Deshabilitada" ? 
                            `<button class="btn btn-sm btn-success flex-fill" onclick="reservarMesa2(${i})">üìå Reservar</button>` : ''}
                    </div>
                `;
                
                body.appendChild(card);
            });
            
            actualizarSelectMesas();
        };

function reservarMesa2(index) {
    // Aqu√≠ podr√≠as hacer l√≥gica previa, cargar datos, etc.
    
    // Mostrar el modal si se llam√≥ desde el bot√≥n "Reservar"
    const modalElement = document.getElementById("modalReservas");
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

        // Reservar una mesa
        // function reservarMesa(i) {
        //     // Verificar si la mesa ya est√° ocupada por una reserva confirmada
        //     if (mesas[i].estado === "Ocupada") {
        //         Swal.fire({
        //             icon: 'error',
        //             title: 'Mesa no disponible',
        //             text: 'Esta mesa ya est√° ocupada por una reserva confirmada'
        //         });
        //         return;
        //     }
            
        //     mesas[i].estado = "Ocupada";
        //     localStorage.setItem("mesas", JSON.stringify(mesas));
        //     pintarDatos();
        //     actualizarEstadisticas();
            
        //     document.getElementById("select-mesa").value = mesas[i].numero;
        //     mostrarFormularioNew();
        // }

        function reservarMesa(i) {
    // Verificar si la mesa ya est√° ocupada
   

    // Volver a pintar las mesas actualizadas
    pintarDatos();
    actualizarEstadisticas();

    // ‚úÖ Mostrar el formulario
    mostrarFormularioNew();

    // ‚úÖ Preseleccionar la mesa en el formulario
    document.getElementById("select-mesa").value = mesas[i].numero;
}


        // Editar una mesa
        window.editarMesa = (i) => {
            const mesa = mesas[i];
            editIndex = i;
            
            document.getElementById("modal-numero").value = mesa.numero;
            document.getElementById("modal-cantidad").value = mesa.cantidad;
            document.getElementById("modal-ubicacion").value = mesa.ubicacion;
            document.getElementById("modal-estado").value = mesa.estado;
            
            document.getElementById("modalMesasLabel").textContent = "Editar mesa";
            
            // Limpiar errores
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
            
            const modal = new bootstrap.Modal(document.getElementById("modalMesas"));
            modal.show();
        };

        // Eliminar una mesa
        window.eliminarMesa = (i) => {
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: "Esta acci√≥n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    mesas.splice(i, 1);
                    localStorage.setItem("mesas", JSON.stringify(mesas));
                    pintarDatos();
                    actualizarEstadisticas();
                    Swal.fire(
                        'Eliminada!',
                        'La mesa ha sido eliminada.',
                        'success'
                    );
                }
            });
        };

        // Mostrar formulario de reserva
    //     function mostrarFormularioNew() {
    //         document.getElementById("formulario").style.display = "block";
    // document.getElementById("formulario").classList.remove("d-none");
            
    //         // Generar ID √∫nico para la reserva
    //         document.getElementById("idreserva").value = Math.floor(1000 + Math.random() * 9000);
            
    //         // Establecer fecha m√≠nima como hoy
    //         const today = new Date().toISOString().split('T')[0];
    //         document.getElementById("Datereserva").setAttribute('min', today);
    //         document.getElementById("Datereserva").value = today;
            
    //         // Establecer hora actual por defecto
    //         const ahora = new Date();
    //         const horas = ahora.getHours().toString().padStart(2, '0');
    //         const minutos = ahora.getMinutes().toString().padStart(2, '0');
    //         document.getElementById("hora-reserva").value = `${horas}:${minutos}`;
    //     }
function mostrarFormularioNew() {
    const formulario = document.getElementById("formulario");

    // Mostrar el formulario
    formulario.style.display = "block";
    formulario.classList.remove("d-none");

    // Generar ID √∫nico para la reserva
    document.getElementById("idreserva").value = Math.floor(1000 + Math.random() * 9000);

    // Establecer fecha m√≠nima como hoy
    const today = new Date().toISOString().split('T')[0];
    const fechaInput = document.getElementById("Datereserva");
    fechaInput.setAttribute('min', today);
    fechaInput.value = today;

    // Establecer hora actual por defecto (formato HH:MM)
    const ahora = new Date();
    const horas = ahora.getHours().toString().padStart(2, '0');
    const minutos = ahora.getMinutes().toString().padStart(2, '0');
    document.getElementById("hora-reserva").value = `${horas}:${minutos}`;
}


function ocultarFormularioNew() {
  document.getElementById("formulario").classList.add("d-none");
}


        // Ocultar formulario de reserva
        // function ocultarFormularioNew() {
        //     document.getElementById("formulario").style.display = "none";
        //     document.getElementById("btnReserva").style.display = "block";
  
        // }
function ocultarFormularioNew() {
  document.getElementById("formulario").classList.add("d-none");
}

        // Limpiar formulario de reserva
        function limpiarFormularioNew() {
            document.getElementById("idreserva").value = "";
            document.getElementById("nombreCliente").value = "";
            document.getElementById("NumReservas").value = "";
            document.getElementById("Datereserva").value = "";
            document.getElementById("hora-reserva").value = "";
            document.getElementById("Notas").value = "";
            document.getElementById("estado").value = "";
            document.getElementById("select-mesa").value = "";
            
            // Limpiar errores
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
        }


// function guardarNew() {
//     // Validaciones
//     let isValid = true;

//     if (!document.getElementById("nombreCliente").value) {
//         document.getElementById("nombreCliente").classList.add('input-error');
//         document.getElementById("errorNombre").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
//         document.getElementById("NumReservas").classList.add('input-error');
//         document.getElementById("errorNombre1").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("Datereserva").value) {
//         document.getElementById("Datereserva").classList.add('input-error');
//         document.getElementById("errorNombre2").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("hora-reserva").value) {
//         document.getElementById("hora-reserva").classList.add('input-error');
//         document.getElementById("errorHora").style.display = 'block';
//         isValid = false;
//     }

//     if (!isValid) return;

//     // Datos
//     const id = document.getElementById("idreserva").value || Date.now().toString();
//     const mesa = document.getElementById("select-mesa").value;
//     const fecha = document.getElementById("Datereserva").value;
//     const hora = document.getElementById("hora-reserva").value;
//     const duracion = parseInt(document.getElementById("duracion-reserva").value);

//     // ‚úÖ Verificar conflictos de horario
//     if (!validarHorarioReserva(mesa, fecha, hora, duracion, id)) {
//         Swal.fire({
//             icon: 'error',
//             title: 'Horario no disponible',
//             text: 'La mesa ya est√° reservada en ese horario. Por favor, elija otro horario o mesa.'
//         });
//         return;
//     }

//     // Crear objeto reserva
//     const reserva = {
//         id,
//         mesa,
//         cliente: document.getElementById("nombreCliente").value,
//         personas: document.getElementById("NumReservas").value,
//         fecha,
//         hora,
//         duracion,
//         ocasion: document.getElementById("ocasiones-especiales").value,
//         notas: document.getElementById("Notas").value,
//         estado: document.getElementById("estado").value,
//         startTime: (["Confirmada", "Ocupada"].includes(document.getElementById("estado").value))
//             ? Date.now()
//             : null
//     };

//     // ‚úÖ Decidir si es nueva o edici√≥n
//     if (editIndexReserva === null) {
//         datos.push(reserva); // nueva
//     } else {
//         datos[editIndexReserva] = reserva; // edici√≥n
//         editIndexReserva = null;
//     }

//     // Guardar
//     localStorage.setItem("reservas", JSON.stringify(datos));

//     // Actualizar mesa si aplica
//     if (["Confirmada", "Ocupada", "Pendiente"].includes(reserva.estado)) {
//         const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
//         if (mesaIndex !== -1) {
//             mesas[mesaIndex].estado = "Ocupada";
//             localStorage.setItem("mesas", JSON.stringify(mesas));

//             if (["Confirmada", "Ocupada"].includes(reserva.estado)) {
//                 iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
//             }
//         }
//     }

//     pintarDatos();
//     pintarDatosNew();
//     actualizarEstadisticas();

//     limpiarFormularioNew();

//     Swal.fire({
//         title: "Reserva guardada correctamente",
//         icon: "success",
//         draggable: true
//     });
// }

function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
    // Limpiar temporizador existente si ya hay uno activo
    if (temporizadoresActivos[reservaId]) {
        clearInterval(temporizadoresActivos[reservaId]);
    }

    temporizadoresActivos[reservaId] = setInterval(() => {
        const ahora = Date.now();
        let reserva = datos.find(r => r.id === reservaId);
        if (!reserva) return; // si ya no existe la reserva, salir

        // ‚úÖ Si la reserva est√° pendiente y no tiene startTime, lo calculamos con la fecha+hora real
        if (reserva.estado === "Pendiente" && !reserva.startTime) {
            reserva.startTime = new Date(`${reserva.fecha}T${reserva.hora}`).getTime();
        }

        // ‚è∞ Cambiar Pendiente ‚Üí Ocupada cuando llegue la hora de inicio real
        if (reserva.estado === "Pendiente" && ahora >= reserva.startTime) {
            reserva.estado = "Ocupada";

            // actualizar mesa tambi√©n
            let mesa = mesas.find(m => m.numero == reserva.mesa);
            if (mesa) mesa.estado = "Ocupada";

            localStorage.setItem("reservas", JSON.stringify(datos));
            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatosNew();
            actualizarEstadisticas();
        }

        // Calcular tiempo restante hasta el fin
        const fin = reserva.startTime + duracionMinutos * 60000;
        const tiempoRestante = fin - ahora;

        if (tiempoRestante <= 0) {
            const el = document.querySelector(`#temporizador-${reservaId}`);
            if (el) {
                el.innerHTML = `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
            }
            clearInterval(temporizadoresActivos[reservaId]);
            delete temporizadoresActivos[reservaId];

            // marcar como finalizada y liberar mesa
            reserva.estado = "Finalizada";
            let mesa = mesas.find(m => m.numero == reserva.mesa);
            if (mesa) mesa.estado = "Libre";

            localStorage.setItem("reservas", JSON.stringify(datos));
            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatosNew();
            actualizarEstadisticas();
            return;
        }

        // Actualizar contador visible en pantalla
        actualizarContadorTemporizador(reservaId, reserva.startTime, duracionMinutos);

    }, 1000); // actualizar cada 1 segundo
}



// Guardar reserva
// function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
//     // Limpiar temporizador existente si hay uno
//     if (temporizadoresActivos[reservaId]) {
//         clearInterval(temporizadoresActivos[reservaId]);
//     }

//     temporizadoresActivos[reservaId] = setInterval(() => {
//         const ahora = Date.now();

//         // Buscar reserva
//         let reserva = datos.find(r => r.id == reservaId); // üëà usa == porque puede ser string o number
//         if (!reserva) {
//             clearInterval(temporizadoresActivos[reservaId]);
//             return;
//         }

//         // ‚è∞ Cambiar Pendiente ‚Üí Ocupada cuando llegue la hora de inicio
//         if (reserva.estado === "Pendiente" && ahora >= startTime) {
//             reserva.estado = "Ocupada";

//             // actualizar tambi√©n mesa si existe
//             let mesa = mesas.find(m => m.numero == reserva.mesa);
//             if (mesa) mesa.estado = "Ocupada";

//             // Guardar cambios
//             localStorage.setItem("reservas", JSON.stringify(datos));
//             localStorage.setItem("mesas", JSON.stringify(mesas));

//             pintarDatosNew(); // refrescar vista
//             pintarDatos?.();  // si tienes otra funci√≥n para lista general
//         }

//         // Calcular tiempo restante hasta fin
//         const fin = startTime + duracionMinutos * 600;
//         const tiempoRestante = fin - ahora;

//         if (tiempoRestante <= 0) {
//             let el = document.querySelector(`#temporizador-${reservaId}`);
//             if (el) {
//                 el.innerHTML = `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
//             }
//             clearInterval(temporizadoresActivos[reservaId]);
//             return;
//         }

//         // Actualizar contador visible
//         actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
//     }, 1000); // cada segundo
// }


// function guardarNew() {
   
//     let isValid = true;
     

//     if (!document.getElementById("nombreCliente").value.trim()) {
//         document.getElementById("nombreCliente").classList.add('input-error');
//         document.getElementById("errorNombre").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
//         document.getElementById("NumReservas").classList.add('input-error');
//         document.getElementById("errorNombre1").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("Datereserva").value) {
//         document.getElementById("Datereserva").classList.add('input-error');
//         document.getElementById("errorNombre2").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("hora-reserva").value) {
//         document.getElementById("hora-reserva").classList.add('input-error');
//         document.getElementById("errorHora").style.display = 'block';
//         isValid = false;
//     }
//  if(!document.getElementById("estado").value==="Finalizada"){
//             document.getElementById("estado").classList.add('input-error');
//             document.getElementById("errorEstado").style.display = 'block';
//             isValid=false;
//         }
//     if(document.getElementById(modal-numero)>= document.getElementById(Numres))


// //  if (reserva[i].cantidad > mesas[i].cantidad) {
// //     document.getElementById("modal-cantidad").classList.add('input-error');
// //     document.getElementById("errorCantidad").innerText = "La cantidad excede la capacidad de la mesa.";
// //     document.getElementById("errorCantidad").style.display = 'block';}

//     if (!isValid) return;

//     // ‚úÖ Validaci√≥n de conflictos de horarios solo si estamos creando una nueva reserva
//     if (editIndexReserva === null) {  // Solo validar cuando es nueva reserva
//         const mesa = document.getElementById("select-mesa").value;
//         const fecha = document.getElementById("Datereserva").value;
//         const hora = document.getElementById("hora-reserva").value;
//         const duracion = parseInt(document.getElementById("duracion-reserva").value);

//         if (!validarHorarioReserva(mesa, fecha, hora, duracion)) {
//             Swal.fire({
//                 icon: 'error',
//                 title: 'Horario no disponible',
//                 text: 'La mesa ya est√° reservada en ese horario. Por favor, elija otro horario o mesa.'
//             });
//             return;
//         }
//     }

//     // üìå Calcular startTime (hora programada en ms)
//     const mesa = document.getElementById("select-mesa").value;
//     const fecha = document.getElementById("Datereserva").value;
//     const hora = document.getElementById("hora-reserva").value;
//     const duracion = parseInt(document.getElementById("duracion-reserva").value);
//     const startTimestamp = new Date(`${fecha}T${hora}`).getTime();
//     const estadoSeleccionado = document.getElementById("estado").value;

//     // Crear objeto de reserva
//     let reserva = {
//         id: document.getElementById("idreserva").value,
//         mesa: mesa,
//         cliente: document.getElementById("nombreCliente").value,
//         personas: document.getElementById("NumReservas").value,
//         fecha: fecha,
//         hora: hora,
//         duracion: duracion,
//         ocasion: document.getElementById("ocasiones-especiales").value,
//         notas: document.getElementById("Notas").value,
//         estado: estadoSeleccionado,
//         startTime: (["Confirmada", "Ocupada"].includes(estadoSeleccionado)) ? Date.now() : startTimestamp
//     };

    
//     // Guardar (nueva o edici√≥n)
//     if (editIndexReserva === null) {
//         datos.push(reserva); // üöÄ Nueva reserva
//     } else {
//         datos[editIndexReserva] = reserva; // ‚úèÔ∏è Editar reserva existente
//         editIndexReserva = null;
//     }

//     // ‚úÖ Actualizar estado de la mesa seg√∫n el estado de la reserva
//     const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
//     if (mesaIndex !== -1) {
//         if (["Confirmada", "Ocupada"].includes(reserva.estado)) {
//             mesas[mesaIndex].estado = "Ocupada"; // Ocupa de inmediato
//             iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
//         } else if (reserva.estado === "Pendiente"){
//             mesas[mesaIndex].estado = "Libre"; // Se mantiene libre hasta la hora real
//             iniciarTemporizador(reserva.id, startTimestamp, reserva.duracion); // ‚è∞ programamos el cambio
//         } 
       
//         else {
//             mesas[mesaIndex].estado = "Libre"; // Cancelada / Finalizada
//         }

//         localStorage.setItem("mesas", JSON.stringify(mesas));
//     }

//  const modal = bootstrap.Modal.getInstance(document.getElementById("modalReservas"));
//             modal.hide();
//     Swal.fire({
//         title: "Reserva guardada correctamente",
//         icon: "success",
//         draggable: true
//     });



//     localStorage.setItem("reservas", JSON.stringify(datos));

//     // Refrescar UI
//     pintarDatos();
//     pintarDatosNew();
//     actualizarEstadisticas();
//     ocultarFormularioNew();
//     limpiarFormularioNew();

 


// }

function guardarNew() {
    // ‚úÖ Validaciones
    let isValid = true;

    if (!document.getElementById("nombreCliente").value.trim()) {
        document.getElementById("nombreCliente").classList.add('input-error');
        document.getElementById("errorNombre").style.display = 'block';
        isValid = false;
    }

    if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
        document.getElementById("NumReservas").classList.add('input-error');
        document.getElementById("errorNombre1").style.display = 'block';
        isValid = false;
    }

    if (!document.getElementById("Datereserva").value) {
        document.getElementById("Datereserva").classList.add('input-error');
        document.getElementById("errorNombre2").style.display = 'block';
        isValid = false;
    }

    if (!document.getElementById("hora-reserva").value) {
        document.getElementById("hora-reserva").classList.add('input-error');
        document.getElementById("errorHora").style.display = 'block';
        isValid = false;
    }
   
        if (document.getElementById("estado").value === "Finalizada") {
    document.getElementById("estado").classList.add('input-error');
    document.getElementById("errorEstado").style.display = 'block';
    isValid = false;
}

     if (document.getElementById("estado").value === "Cancelada") {
    document.getElementById("estado").classList.add('input-error');
    document.getElementById("errorEstado").style.display = 'block';
    isValid = false;
}

    if (!isValid) return;

    // ‚úÖ Validaci√≥n de conflictos de horarios solo si estamos creando una nueva reserva
    if (editIndexReserva === null) {  // Solo validar cuando es nueva reserva
        const mesa = document.getElementById("select-mesa").value;
        const fecha = document.getElementById("Datereserva").value;
        const hora = document.getElementById("hora-reserva").value;
        const duracion = parseInt(document.getElementById("duracion-reserva").value);

        if (!validarHorarioReserva(mesa, fecha, hora, duracion)) {
            Swal.fire({
                icon: 'error',
                title: 'Horario no disponible',
                text: 'La mesa ya est√° reservada en ese horario. Por favor, elija otro horario o mesa.'
            });
            return;
        }
    }

    // üìå Calcular startTime (hora programada en ms)
    const mesa = document.getElementById("select-mesa").value;
    const fecha = document.getElementById("Datereserva").value;
    const hora = document.getElementById("hora-reserva").value;
    const duracion = parseInt(document.getElementById("duracion-reserva").value);
    const startTimestamp = new Date(`${fecha}T${hora}`).getTime();
    const estadoSeleccionado = document.getElementById("estado").value;

    // Crear objeto de reserva
    let reserva = {
        id: document.getElementById("idreserva").value,
        mesa: mesa,
        cliente: document.getElementById("nombreCliente").value,
        personas: document.getElementById("NumReservas").value,
        fecha: fecha,
        hora: hora,
        duracion: duracion,
        ocasion: document.getElementById("ocasiones-especiales").value,
        notas: document.getElementById("Notas").value,
        estado: estadoSeleccionado,
        startTime: (["Confirmada", "Ocupada"].includes(estadoSeleccionado)) ? Date.now() : startTimestamp
    };

    
    // Guardar (nueva o edici√≥n)
    if (editIndexReserva === null) {
        datos.push(reserva); // üöÄ Nueva reserva
    } else {
        datos[editIndexReserva] = reserva; // ‚úèÔ∏è Editar reserva existente
        editIndexReserva = null;
    }

    // ‚úÖ Actualizar estado de la mesa seg√∫n el estado de la reserva
    const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
    if (mesaIndex !== -1) {
        if (["Confirmada", "Ocupada"].includes(reserva.estado)) {
            mesas[mesaIndex].estado = "Ocupada"; // Ocupa de inmediato
            iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
        } else if (reserva.estado === "Pendiente") {
            mesas[mesaIndex].estado = "Libre"; // Se mantiene libre hasta la hora real
            iniciarTemporizador(reserva.id, startTimestamp, reserva.duracion); // ‚è∞ programamos el cambio
        } else {
            mesas[mesaIndex].estado = "Libre"; // Cancelada / Finalizada
        }

        localStorage.setItem("mesas", JSON.stringify(mesas));
    }

 const modal = bootstrap.Modal.getInstance(document.getElementById("modalReservas"));
            modal.hide();
    Swal.fire({
        title: "Reserva guardada correctamente",
        icon: "success",
        draggable: true
    });



    localStorage.setItem("reservas", JSON.stringify(datos));

    // Refrescar UI
    pintarDatos();
    pintarDatosNew();
    actualizarEstadisticas();
    ocultarFormularioNew();
    limpiarFormularioNew();

 


}





      // Guardar reserva
// function guardarNew() {
//     // Validaciones
//     let isValid = true;

//     if (!document.getElementById("nombreCliente").value) {
//         document.getElementById("nombreCliente").classList.add('input-error');
//         document.getElementById("errorNombre").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
//         document.getElementById("NumReservas").classList.add('input-error');
//         document.getElementById("errorNombre1").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("Datereserva").value) {
//         document.getElementById("Datereserva").classList.add('input-error');
//         document.getElementById("errorNombre2").style.display = 'block';
//         isValid = false;
//     }

//     if (!document.getElementById("hora-reserva").value) {
//         document.getElementById("hora-reserva").classList.add('input-error');
//         document.getElementById("errorHora").style.display = 'block';
//         isValid = false;
//     }

//     if (!isValid) return;

//     // ‚úÖ Validaci√≥n de conflictos de horarios
//     const mesa = document.getElementById("select-mesa").value;
//     const fecha = document.getElementById("Datereserva").value;
//     const hora = document.getElementById("hora-reserva").value;
//     const duracion = parseInt(document.getElementById("duracion-reserva").value);

//     if (!validarHorarioReserva(mesa, fecha, hora, duracion)) {
//         Swal.fire({
//             icon: 'error',
//             title: 'Horario no disponible',
//             text: 'La mesa ya est√° reservada en ese horario. Por favor, elija otro horario o mesa.'
//         });
//         return;
//     }

//     // Crear objeto de reserva
//     let reserva = {
//         id: document.getElementById("idreserva").value,
//         mesa: mesa,
//         cliente: document.getElementById("nombreCliente").value,
//         personas: document.getElementById("NumReservas").value,
//         fecha: fecha,
//         hora: hora,
//         duracion: duracion,
//         ocasion: document.getElementById("ocasiones-especiales").value,
//         notas: document.getElementById("Notas").value,
//         estado: document.getElementById("estado").value,
//         startTime: (["Confirmada", "Ocupada"].includes(document.getElementById("estado").value)) ? Date.now() : null
//     };

//     // Guardar (nueva o edici√≥n)
//     if (editIndexReserva === null) {
//         datos.push(reserva); // üöÄ Nueva reserva
//     } else {
//         datos[editIndexReserva] = reserva; // ‚úèÔ∏è Editar reserva existente
//         editIndexReserva = null;
//     }

//     // Guardar en localStorage
//     localStorage.setItem("reservas", JSON.stringify(datos));

//     // Actualizar estado de la mesa
//     if (["Confirmada", "Ocupada"].includes(reserva.estado)) {
//         const mesaIndex = mesas.findIndex(m => m.numero == reserva.mesa);
//         if (mesaIndex !== -1) {
//             mesas[mesaIndex].estado = "Ocupada"; // ‚ö° Se marca como ocupada
//             localStorage.setItem("mesas", JSON.stringify(mesas));

//             // Iniciar temporizador solo para Confirmada u Ocupada
//             if (["Confirmada", "Ocupada"].includes(reserva.estado)) {
//                 iniciarTemporizador(reserva.id, reserva.startTime, reserva.duracion);
//             }
//         }
//     }

//     // Refrescar UI
//     pintarDatos();
//     pintarDatosNew();
//     actualizarEstadisticas();
//     ocultarFormularioNew();
//     limpiarFormularioNew();

//     Swal.fire({
//         title: "Reserva guardada correctamente",
//         icon: "success",
//         draggable: true
//     });
// }




        // Pintar reservas en la tabla
//         function pintarDatosNew() {
//             const infoData = document.getElementById("infoData");
//             const filtroConfirmadas = document.getElementById("filtroConfirmadas");

//             infoData.innerHTML = "";         // Limpia tabla principal
//             filtroConfirmadas.innerHTML = ""; // Limpia la secci√≥n de confirmadas

//             datos.forEach((item, i) => {
//                 // üéØ Crear fila normal
//                 let tr = document.createElement("tr");
                
//                 // Calcular tiempo transcurrido si hay startTime
//                 let tiempoInfo = "";
//                 if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada" || item.estado === "Pendiente")) {
//                     tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;
//                 } else {
//                     tiempoInfo = "<td>-</td>";
//                 }
                
//                 tr.innerHTML = `

//                     <td>${item.id}</td>
//                     <td>${item.mesa}</td>
//                     <td>${item.cliente}</td>
//                     <td>${item.personas}</td>
//                     <td>${item.fecha}</td>
//                     <td>${item.hora || '-'}</td>
//                     <td>${item.duracion ? (item.duracion / 6) + ' h' : '-'}</td>
//                     <td>${item.ocasion} 
//                         <br>
//                         ${getImagenPorOcasion(item.ocasion)}
//                         </td>
                  
//                     <td>${item.notas}</td>
//                     <td>
//                         <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
//                                         item.estado === 'Pendiente' ? 'bg-warning' : 
//                                         item.estado === 'Cancelada' ? 'bg-danger' : 
//                                         item.estado === 'Ocupada' ? 'bg-primary' : 'bg-secondary'}">
//                             ${item.estado}
//                         </span>
//                     </td>
//                     ${tiempoInfo}
//                  <td>
//     ${item.estado !== 'Finalizada' ? 
//         `<button class="btn btn-warning btn-sm" onclick="editarReservaNew(${i})">‚úèÔ∏è Editar</button>` 
//         : ''}
//     <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${i})">üóëÔ∏è Eliminar</button>
//     ${item.estado === 'Confirmada' || item.estado === 'Ocupada' ? 
//         `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${i})">üíµ Pagar</button>` 
//         : ''}
// </td>

//                 `;
//                 infoData.appendChild(tr);

//                 // Iniciar temporizador si corresponde
//                 if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada")) {
//                     iniciarTemporizador(item.id, parseInt(item.startTime), parseInt(item.duracion));
//                 }

//                 // üéØ Si es confirmada u ocupada, agregamos su info a la secci√≥n especial
//                 if (item.estado === "Confirmada" || item.estado === "Pendiente") {
//                     let div = document.createElement("div");
//                     div.classList.add("card", "p-2", "mb-2", "border", "rounded");
                    
//                     if (item.estado === "Confirmada") {
//                         div.classList.add("border-success");
//                         div.style.background = "linear-gradient(to right, #ffe259, #ffa751)";
//                     } else {
//                         div.classList.add("border-primary");
//                         div.style.background = "linear-gradient(to right, #4facfe, #00f2fe)";
//                         div.style.color = "white";
//                     }
                    
//                     // Calcular tiempo restante si hay startTime
//                     let tiempoRestanteInfo = "";
//                     if (item.startTime && item.duracion) {
//                         const ahora = Date.now();
//                         const tiempoTranscurrido = Math.floor((ahora - item.startTime) / 60000);
//                         const tiempoRestante = item.duracion - tiempoTranscurrido;
                        
//                         if (tiempoRestante > 0) {
//                             tiempoRestanteInfo = `<br><strong>Tiempo restante:</strong> ${tiempoRestante} minutos`;
//                         } else {
//                             tiempoRestanteInfo = `<br><strong class="temporizador-activo">‚è∞ Tiempo cumplido</strong>`;
//                         }
//                     }
                    
//                     div.innerHTML = `
//                         <h4>Mesa ${item.estado.toLowerCase()}</h4>
//                         <strong>Mesa:</strong> ${item.mesa} |
//                         <strong>Cliente:</strong> ${item.cliente} |
//                         <strong>Hora:</strong> ${item.hora}${tiempoRestanteInfo}
//                     `;

//                     filtroConfirmadas.appendChild(div);
//                 } else if (item.estado === "Pendiente") {
//                     let div2 = document.createElement("div");
//                     div2.classList.add("card", "p-2", "mb-2", "border", "border-warning", "rounded");
//                     div2.style.background = "rgb(255, 255, 200)";
//                     div2.innerHTML = `
//                         <h4>Reserva Pendiente</h4>
//                         <strong>Mesa:</strong> ${item.mesa} |
//                         <strong>Cliente:</strong> ${item.cliente} |
//                         <strong>Fecha:</strong> ${item.fecha} |
//                         <strong>Hora:</strong> ${item.hora}
//                     `;

//                     filtroConfirmadas.appendChild(div2);
//                          }
//             });
//         }

function pintarDatosNew() {
    const infoData = document.getElementById("infoData");
    const filtroConfirmadas = document.getElementById("filtroConfirmadas");

    const fechaSeleccionada = document.getElementById("filtroFecha")?.value || "";
    const estadoSeleccionado = document.getElementById("filtroEstado")?.value || "";

    infoData.innerHTML = "";         
    filtroConfirmadas.innerHTML = ""; 

    // üîé Aplicar filtros
    let reservasFiltradas = datos;

    if (fechaSeleccionada) {
        reservasFiltradas = reservasFiltradas.filter(item => item.fecha === fechaSeleccionada);
    }

    if (estadoSeleccionado) {
        reservasFiltradas = reservasFiltradas.filter(item => item.estado === estadoSeleccionado);
    }

    // Si no hay resultados
    if (reservasFiltradas.length === 0) {
        infoData.innerHTML = `<tr><td colspan="12" class="text-center">No hay reservas con los filtros aplicados</td></tr>`;
        return;
    }

    reservasFiltradas.forEach((item, i) => {
        let tr = document.createElement("tr");

        // Calcular tiempo
        let tiempoInfo = "";
        if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada" || item.estado === "Pendiente")) {
            tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;
        } else {
            tiempoInfo = "<td>-</td>";
        }

        tr.innerHTML = `
            <td>${item.id}</td>
            <td>${item.mesa}</td>
            <td>${item.cliente}</td>
            <td>${item.personas}</td>
            <td>${item.fecha}</td>
            <td>${item.hora || '-'}</td>
            <td>${item.duracion ? (item.duracion / 6) + ' h' : '-'}</td>
            <td>${item.ocasion}<br>${getImagenPorOcasion(item.ocasion)}</td>
            <td>${item.notas}</td>
            <td>
                <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
                                    item.estado === 'Pendiente' ? 'bg-warning' : 
                                    item.estado === 'Cancelada' ? 'bg-danger' : 
                                    item.estado === 'Ocupada' ? 'bg-primary' : 'bg-secondary'}">
                    ${item.estado}
                </span>
            </td>
            ${tiempoInfo}
            <td>
                ${item.estado !== 'Finalizada' ? 
                    `<button class="btn btn-warning btn-sm" onclick="editarReservaNew(${i})">‚úèÔ∏è Editar</button>` 
                    : ''}
                <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${i})">üóëÔ∏è Eliminar</button>
                ${item.estado === 'Confirmada' || item.estado === 'Ocupada' ? 
                    `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${i})">üíµ Pagar</button>` 
                    : ''}
            </td>
        `;
        infoData.appendChild(tr);

        // Temporizador
        if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada")) {
            iniciarTemporizador(item.id, parseInt(item.startTime), parseInt(item.duracion));
        }

        // Tarjetas confirmadas/pendientes
        if (item.estado === "Confirmada" || item.estado === "Pendiente") {
            let div = document.createElement("div");
            div.classList.add("card", "p-2", "mb-2", "border", "rounded");

            if (item.estado === "Confirmada") {
                div.classList.add("border-success");
                div.style.background = "linear-gradient(to right, #ffe259, #ffa751)";
            } else {
                div.classList.add("border-primary");
                div.style.background = "linear-gradient(to right, #4facfe, #00f2fe)";
                div.style.color = "white";
            }

            div.innerHTML = `
                <h4>Mesa ${item.estado.toLowerCase()}</h4>
                <strong>Mesa:</strong> ${item.mesa} |
                <strong>Cliente:</strong> ${item.cliente} |
                <strong>Hora:</strong> ${item.hora}
            `;
            filtroConfirmadas.appendChild(div);
        }

   Swal.fire({
        title: "Elige el filtro fecha y estado para poder ver tus reservas",
        icon: "success",
        draggable: true
    });
    });
}


// function pintarDatosNew() {
//     const infoData = document.getElementById("infoData");
//     const filtroConfirmadas = document.getElementById("filtroConfirmadas");
//     const contenedorFiltradas = document.getElementById("contenedorReservasFiltradas");

//     // Limpiar
//     infoData.innerHTML = "";
//     filtroConfirmadas.innerHTML = "";
//     contenedorFiltradas.innerHTML = "";

//     // Obtener fecha seleccionada en el filtro
//     const filtroFecha = document.getElementById("filtroFecha").value;

//     datos.forEach((item, i) => {
//         // üéØ Crear fila normal
//         let tr = document.createElement("tr");

//         // Calcular tiempo transcurrido si hay startTime
//         let tiempoInfo = "";
//         if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada" || item.estado === "Pendiente")) {
//             tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;
//         } else {
//             tiempoInfo = "<td>-</td>";
//         }

//         tr.innerHTML = `
//             <td>${item.id}</td>
//             <td>${item.mesa}</td>
//             <td>${item.cliente}</td>
//             <td>${item.personas}</td>
//             <td>${item.fecha}</td>
//             <td>${item.hora || '-'}</td>
//             <td>${item.duracion ? (item.duracion / 6) + ' h' : '-'}</td>
//             <td>${item.ocasion} 
//                 <br>
//                 ${getImagenPorOcasion(item.ocasion)}
//             </td>
//             <td>${item.notas}</td>
//             <td>
//                 <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
//                                     item.estado === 'Pendiente' ? 'bg-warning' : 
//                                     item.estado === 'Cancelada' ? 'bg-danger' : 
//                                     item.estado === 'Ocupada' ? 'bg-primary' : 'bg-secondary'}">
//                     ${item.estado}
//                 </span>
//             </td>
//             ${tiempoInfo}
//             <td>
//                 ${item.estado !== 'Finalizada' ? 
//                     `<button class="btn btn-warning btn-sm" onclick="editarReservaNew(${i})">‚úèÔ∏è Editar</button>` 
//                     : ''}
//                 <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${i})">üóëÔ∏è Eliminar</button>
//                 ${item.estado === 'Confirmada' || item.estado === 'Ocupada' ? 
//                     `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${i})">üíµ Pagar</button>` 
//                     : ''}
//             </td>
//         `;

//         // üëâ Siempre pintamos todas en la tabla principal
//         infoData.appendChild(tr);

//         // üëâ Si hay filtro de fecha y coincide, tambi√©n lo pintamos en tabla de filtradas
//         if (filtroFecha && item.fecha === filtroFecha) {
//             let trFiltrada = tr.cloneNode(true); // clonamos fila
//             contenedorFiltradas.appendChild(trFiltrada);
//         }

//         // Iniciar temporizador si corresponde
//         if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada")) {
//             iniciarTemporizador(item.id, parseInt(item.startTime), parseInt(item.duracion));
//         }

//         // üéØ Si es confirmada u ocupada, agregamos su info a la secci√≥n especial
//         if (item.estado === "Confirmada" || item.estado === "Pendiente") {
//             let div = document.createElement("div");
//             div.classList.add("card", "p-2", "mb-2", "border", "rounded");
            
//             if (item.estado === "Confirmada") {
//                 div.classList.add("border-success");
//                 div.style.background = "linear-gradient(to right, #ffe259, #ffa751)";
//             } else {
//                 div.classList.add("border-primary");
//                 div.style.background = "linear-gradient(to right, #4facfe, #00f2fe)";
//                 div.style.color = "white";
//             }

//             div.innerHTML = `
//                 <h4>Mesa ${item.estado.toLowerCase()}</h4>
//                 <strong>Mesa:</strong> ${item.mesa} |
//                 <strong>Cliente:</strong> ${item.cliente} |
//                 <strong>Hora:</strong> ${item.hora}
//             `;

//             filtroConfirmadas.appendChild(div);
//         }
//     });
// }

        // Editar reserva
     // Variable global para saber cu√°l reserva estamos editando
// let editIndexReserva = null;

// // Editar reserva
// // Editar reserva
// function editarReservaNew(i) {
//     let item = datos[i];

//     // Cargar valores en el formulario
//     document.getElementById("idreserva").value = item.id;
//     document.getElementById("select-mesa").value = item.mesa;
//     document.getElementById("nombreCliente").value = item.cliente;
//     document.getElementById("NumReservas").value = item.personas;
//     document.getElementById("Datereserva").value = item.fecha;
//     document.getElementById("hora-reserva").value = item.hora || "";
//     document.getElementById("duracion-reserva").value = item.duracion;
//     document.getElementById("ocasiones-especiales").value = item.ocasion;
//     document.getElementById("Notas").value = item.notas;
//     document.getElementById("estado").value = item.estado;

//     // ‚úÖ Mostrar modal usando Bootstrap
//     const modal = new bootstrap.Modal(document.getElementById("modalReservas"));
//     modal.show();

//     // Guardamos el √≠ndice que estamos editando
//     editIndexReserva = i;
// }


// Variable global que ya tienes
let editIndexReserva = null;

// Funci√≥n que abre el modal con datos para editar
function editarReservaNew(i) {
    let item = datos[i];

    document.getElementById("idreserva").value = item.id;
    document.getElementById("select-mesa").value = item.mesa;
    document.getElementById("nombreCliente").value = item.cliente;
    document.getElementById("NumReservas").value = item.personas;
    document.getElementById("Datereserva").value = item.fecha;
    document.getElementById("hora-reserva").value = item.hora || "";
    document.getElementById("duracion-reserva").value = item.duracion;
    document.getElementById("ocasiones-especiales").value = item.ocasion;
    document.getElementById("Notas").value = item.notas;
    document.getElementById("estado").value = item.estado;

    // Mostrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    editIndexReserva = i;

    // Crear bot√≥n "Guardar cambios" din√°micamente
    let footer = modalEl.querySelector(".modal-footer");
    
    // Limpiar cualquier bot√≥n anterior
    footer.innerHTML = "";

    const btnGuardar = document.createElement("button");
    btnGuardar.className = "btn btn-primary";
    btnGuardar.textContent = "Guardar cambios";
    btnGuardar.onclick = guardarCambiosReserva; // funci√≥n que actualiza los datos

    footer.appendChild(btnGuardar);
}


// Funci√≥n para guardar cambios
function guardarCambiosReserva() {
    if (editIndexReserva === null) return; // no hay reserva seleccionada

    // Actualizar el array 'datos' con los valores del formulario
    datos[editIndexReserva] = {
        id: document.getElementById("idreserva").value,
        mesa: document.getElementById("select-mesa").value,
        cliente: document.getElementById("nombreCliente").value,
        personas: document.getElementById("NumReservas").value,
        fecha: document.getElementById("Datereserva").value,
        hora: document.getElementById("hora-reserva").value,
        duracion: document.getElementById("duracion-reserva").value,
        ocasion: document.getElementById("ocasiones-especiales").value,
        notas: document.getElementById("Notas").value,
        estado: document.getElementById("estado").value
    };

    // Opcional: cerrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    // Limpiar √≠ndice
    editIndexReserva = null;

    // Refrescar la tabla o lista de reservas en pantalla
    renderTablaReservas();
}
// Variable global que ya tienes


// Funci√≥n que abre el modal con datos para editar
function editarReservaNew(i) {
    let item = datos[i];

    document.getElementById("idreserva").value = item.id;
    document.getElementById("select-mesa").value = item.mesa;
    document.getElementById("nombreCliente").value = item.cliente;
    document.getElementById("NumReservas").value = item.personas;
    document.getElementById("Datereserva").value = item.fecha;
    document.getElementById("hora-reserva").value = item.hora || "";
    document.getElementById("duracion-reserva").value = item.duracion;
    document.getElementById("ocasiones-especiales").value = item.ocasion;
    document.getElementById("Notas").value = item.notas;
    document.getElementById("estado").value = item.estado;

    const modal = new bootstrap.Modal(document.getElementById("modalReservas"));
    modal.show();

    editIndexReserva = i;
}

// Funci√≥n para guardar cambios
function guardarCambiosReserva() {
    if (editIndexReserva === null) return; // no hay reserva seleccionada

    // Actualizar el array 'datos' con los valores del formulario
    datos[editIndexReserva] = {
        id: document.getElementById("idreserva").value,
        mesa: document.getElementById("select-mesa").value,
        cliente: document.getElementById("nombreCliente").value,
        personas: document.getElementById("NumReservas").value,
        fecha: document.getElementById("Datereserva").value,
        hora: document.getElementById("hora-reserva").value,
        duracion: document.getElementById("duracion-reserva").value,
        ocasion: document.getElementById("ocasiones-especiales").value,
        notas: document.getElementById("Notas").value,
        estado: document.getElementById("estado").value
    };

    // Opcional: cerrar modal
    const modalEl = document.getElementById("modalReservas");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    // Limpiar √≠ndice
    editIndexReserva = null;

    // Refrescar la tabla o lista de reservas en pantalla
    renderTablaReservas();
}


        // Eliminar reserva
      function eliminarReservaNew(i) {
    Swal.fire({
        title: '¬øEst√° seguro?',
        text: "Esta acci√≥n no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Detener temporizador si est√° activo
            const reservaId = datos[i].id;
            if (temporizadoresActivos[reservaId]) {
                clearInterval(temporizadoresActivos[reservaId]);
                delete temporizadoresActivos[reservaId];
            }

            // üîì Liberar la mesa solo si estaba activa
            if (["Confirmada", "Ocupada", "Pendiente"].includes(datos[i].estado)) {
                const mesaIndex = mesas.findIndex(m => m.numero == datos[i].mesa);
                if (mesaIndex !== -1) {
                    mesas[mesaIndex].estado = "Libre";
                    localStorage.setItem("mesas", JSON.stringify(mesas));
                    pintarDatos();
                }
            }

            // üóëÔ∏è Eliminar siempre la reserva
            datos.splice(i, 1);
            localStorage.setItem("reservas", JSON.stringify(datos));

            // Refrescar interfaz
            pintarDatosNew();
            actualizarEstadisticas();

            Swal.fire(
                'Eliminada!',
                'La reserva ha sido eliminada.',
                'success'
            );
        }
    });
}


        // Pagar cuenta
        function pagarCuenta(i) {
            let item = datos[i];
            item.estado = "Finalizada";
            
            // Detener temporizador si est√° activo
            if (temporizadoresActivos[item.id]) {
                clearInterval(temporizadoresActivos[item.id]);
                delete temporizadoresActivos[item.id];
            }
            
            // Liberar la mesa
            const mesaIndex = mesas.findIndex(m => m.numero == item.mesa);
            if (mesaIndex !== -1) {
                mesas[mesaIndex].estado = "Libre";
                localStorage.setItem("mesas", JSON.stringify(mesas));
                pintarDatos();
            }
            
            localStorage.setItem("reservas", JSON.stringify(datos));
            pintarDatosNew();
            actualizarEstadisticas();
            
            Swal.fire(`La cuenta de ${item.cliente} (Mesa ${item.mesa}) ha sido pagada ‚úÖ`, '', 'success');
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            document.getElementById("total-mesas").textContent = mesas.length;
            document.getElementById("mesas-libres").textContent = mesas.filter(m => m.estado === "Libre").length;
            document.getElementById("total-reservas").textContent = datos.length;
            
            // Mostrar reservas de hoy
            const today = new Date().toISOString().split('T')[0];
            const reservasHoy = datos.filter(r => r.fecha === today);
            const reservasHoyContainer = document.getElementById("reservas-hoy");
            
            if (reservasHoy.length === 0) {
                reservasHoyContainer.innerHTML = '<div class="text-center p-3 border rounded">No hay reservas para hoy</div>';
            } else {
                let html = '';
                reservasHoy.forEach(r => {
                    html += `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>Mesa ${r.mesa}</strong>
                                <span class="badge bg-primary">${r.estado}</span>
                            </div>
                            <div>${r.cliente} (${r.personas} personas)</div>
                            <div>Hora: ${r.hora}</div>
                            <small class="text-muted">${r.ocasion}</small>
                        </div>
                    `;
                });
                reservasHoyContainer.innerHTML = html;
            }
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener("DOMContentLoaded", function() {
            pintarDatos();
            pintarDatosNew();
            actualizarEstadisticas();
            recuperarTemporizadores();
            document.getElementById("btnGuardarModal").addEventListener("click", guardarDesdeModal);
        });
    </script>
</body>
</html>








